@page "/login"
@using Microsoft.AspNetCore.Components.Forms
@using Planner.BlazorApp.Auth
@using Planner.BlazorApp.FormModels
@using Planner.BlazorApp.Services
@using Planner.Contracts.API.Auth

@inject PlannerApiClient ApiClient
@inject IJwtTokenStore TokenStore
@inject NavigationManager Nav

<div class="login-page">
    <div class="login-card">
        <div class="login-main">
            @if (!IsLoggedIn) {
                <h2>Planner Demo Login</h2>

                @* method="post" is required for Static SSR *@
                <EditForm Model="form" OnValidSubmit="DoLoginAsync" FormName="LoginForm" method="post" Enhance>
                    <AntiforgeryToken />

                    <div class="login-field">
                        <label>Email</label>
                        <InputText class="login-input" @bind-Value="form.Email" />
                    </div>

                    <div class="login-field">
                        <label>Password</label>
                        <InputText class="login-input" type="password" @bind-Value="form.Password" />
                    </div>

                    <button type="submit" class="login-button" disabled="@IsBusy">
                        @(IsBusy ? "Signing in..." : "Login")
                    </button>
                </EditForm>

                @if (!string.IsNullOrEmpty(error)) {
                    <p class="login-error">@error</p>
                }
            } else {
                <h2>You are logged in</h2>
                <p class="login-status">Your session is active.</p>

                @* Logout usually needs a form post too if you want to clear cookies securely *@
                <form method="post" @onsubmit="DoLogout" action="auth/logout">
                    <AntiforgeryToken />
                    <button type="submit" class="logout-button">Logout</button>
                </form>

                <button class="secondary-button" @onclick="NavigateToApp">
                    Go to Dispatch Center
                </button>
            }
        </div>

        <div class="login-hint-wrapper">
            @LoginHint
        </div>
    </div>
</div>

@code {
    // This allows Blazor to capture the submitted form data
    [SupplyParameterFromForm]
    private LoginFormModel form { get; set; } = new() {
        Email = "perth.admin@demo.local",
        Password = "admin123"
    };

    private string? error;
    private bool IsBusy;

    private bool IsLoggedIn => TokenStore.IsAuthenticated && !TokenStore.IsExpired();

    private async Task DoLoginAsync() {
        if (IsBusy) return;
        error = null;
        IsBusy = true;

        try {
            var response = await ApiClient.PostAsJsonAsync("auth/login", form.ToRequestDto());

            if (!response.IsSuccessStatusCode) {
                error = "Invalid credentials.";
                return;
            }

            var result = await response.Content.ReadFromJsonAsync<LoginResponse>();
            TokenStore.Set(result!.AccessToken);

            Nav.NavigateTo("/dispatch-center");
        } catch (Exception ex) {
            error = ex.Message;
        } finally {
            IsBusy = false;
        }
    }

    private void DoLogout() {
        TokenStore.Clear();
        Nav.NavigateTo("/login", forceLoad: true);
    }

    private void NavigateToApp() => Nav.NavigateTo("/dispatch-center");
    private RenderFragment LoginHint => builder => {
        builder.AddMarkupContent(0, @"
<div class=""login-hint"">
    <p class=""login-hint-title"">Demo tenant access</p>

    <p class=""login-hint-intro"">
        Planner is configured with multiple demo tenants.
        Each tenant represents an independent city environment.
    </p>

    <div class=""tenant-example"">
        <p><strong>Example tenant: Perth</strong></p>

        <p>
            <strong>Admin</strong><br />
            Email: <code>perth.admin@demo.local</code><br />
            Password: <code>admin123</code>
        </p>

        <p>
            <strong>User</strong><br />
            Email: <code>perth.user@demo.local</code><br />
            Password: <code>user123</code>
        </p>
    </div>

    <p class=""login-hint-footnote"">
        To access other demo tenants, replace <code>perth</code> in the email address with one of:
        <br />
        <code>sydney</code>, <code>melbourne</code>, <code>taipei</code>, <code>auckland</code>, <code>christchurch</code>.
        <br /><br />
        Roles are inferred from the email naming convention.
        Credentials are intentionally visible for demo purposes.
    </p>
</div>");
    };
}
