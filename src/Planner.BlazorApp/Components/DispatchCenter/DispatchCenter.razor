@page "/dispatch-center"
@rendermode InteractiveServer

@using Planner.BlazorApp.Auth
@using Planner.BlazorApp.Forms
@using Planner.BlazorApp.Models
@using Planner.BlazorApp.Components.WelcomeWizard
@using Planner.BlazorApp.Services
@using Planner.Domain

@inject DataCenterState DataCenter
@inject IConfiguration Configuration
@inject IJwtTokenStore TokenStore
@inject WizardService Wizard

<CascadingValue Value="DataCenter">
<div class="planner-view d-flex flex-column flex-fill">
    <!-- Top toolbar -->
    <div class="toolbar p-2 d-flex align-items-center bg-light border-bottom">
        <div class="d-flex gap-2">
                <button class="btn btn-info" @onclick="ShowWelcomeGuide">Show Welcome Guide</button>
                @if (TokenStore.IsAuthenticated && TokenStore.AccessToken!.GetRole() == "Admin") {
                <button class="btn btn-primary" @onclick=@(() => OpenTab("Customers"))>Planning Wizard</button>
            }
        </div>
        <h5 class="ms-auto mb-0">Dispatch Centre</h5>
    </div>

    <!-- Map area -->
    <div class="planner-map-area flex-fill position-relative">
        <PlannerMap @ref="mapRef"
                    DepotLat="@DataCenter.MapDepotLocation.Latitude"
                    DepotLon="@DataCenter.MapDepotLocation.Longitude"
                    JobPositionPicked="JobPositionPicked"
                    Routes="@DataCenter.MapRoutes"
                    Customers="@DataCenter.MapCustomers" />
    </div>
    <WelcomeWizardModal />

    <PlannerEntitiesModal @ref="entitiesModal" />
    <NewCustomerModal @ref="newCustomerModal" OnCustomerCreated="HandleNewCustomer" />

</div>
</CascadingValue>

@code {
    private bool _subscribed;

    private PlannerEntitiesModal? entitiesModal;
    private PlannerMap? mapRef;
    private NewCustomerModal? newCustomerModal;

    protected override async Task OnInitializedAsync() {
        if (_subscribed) return;

        DataCenter.CollectionChanged += OnCollectionChanged;
        await EnsureTenantInitializedAsync();

        DataCenter.OnCustomerChanged += OnCustomerChanged;

        _subscribed = true;
    }

    private async void OnCustomerChanged(DataChangedEventArgs<Customer> customerChange) {
        // 1. Update the UI to reflect changes in the customer list/sidebar
        await InvokeAsync(StateHasChanged);

        // 2. If the customer has geographical data, update the map marker or center the view
        if (mapRef != null) {
            // Assuming your PlannerMap has a method to refresh or focus on a specific point
            await mapRef.OnCustomerChanged(customerChange);
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (_subscribed)
            await EnsureTenantInitializedAsync();
    }

    private async Task EnsureTenantInitializedAsync()
    {
        if (!TokenStore.IsAuthenticated || string.IsNullOrWhiteSpace(TokenStore.AccessToken))
            return;

        var tokenTenantId = TokenStore.AccessToken.GetTenantId();
        if (tokenTenantId is null)
            return;

        await DataCenter.InitializeAsync(tokenTenantId.Value);
    }

    private async void OnCollectionChanged(string _) {
        await InvokeAsync(StateHasChanged);
    }

    private void OpenTab(string tab) {
        entitiesModal?.OpenTab(tab);
    }

    private void ShowWelcomeGuide() {
        Wizard.Open(startStep: 0);
    }

    private Task JobPositionPicked(MapPosition args) {
        newCustomerModal?.Open(args);
        return Task.CompletedTask;
    }

    private async Task HandleNewCustomer(CustomerFormModel customer) {
        await DataCenter.AddNewCustomerAsync(customer);
    }

    public void Dispose() {
        DataCenter.CollectionChanged -= OnCollectionChanged;
    }
}
