@page "/dispatch-center"
@rendermode InteractiveServer

@using Planner.BlazorApp.Auth
@using Planner.BlazorApp.Models
@using Planner.BlazorApp.Components.WelcomeWizard
@using Planner.BlazorApp.Services
@using Planner.Contracts.Optimization.Inputs

@inject DataCenterState DataCenter
@inject IConfiguration Configuration
@inject IJwtTokenStore TokenStore

<CascadingValue Value="DataCenter">
<div class="planner-view d-flex flex-column flex-fill">
    <!-- Top toolbar -->
    <div class="toolbar p-2 d-flex align-items-center bg-light border-bottom">
        <div class="d-flex gap-2">
            <button class="btn btn-info" @onclick=@(() => showWizard = true)>Show Welcome Guide</button>
            @if (TokenStore.IsAuthenticated && TokenStore.AccessToken!.GetRole() == "Admin") {
                <button class="btn btn-primary" @onclick=@(() => OpenTab("Customers"))>Optimization Wizard</button>
            }
        </div>
        <h5 class="ms-auto mb-0">Dispatch Centre</h5>
    </div>

    <!-- Map area -->
    <div class="planner-map-area flex-fill position-relative">
        <PlannerMap @ref="mapRef"
                    DepotLat="@DataCenter.MapDepotLocation.Latitude"
                    DepotLon="@DataCenter.MapDepotLocation.Longitude"
                    JobPositionPicked="JobPositionPicked"
                    Routes="@DataCenter.MapRoutes"
                    Customers="@DataCenter.MapCustomers" />
    </div>

    <WelcomeWizardModal IsOpen="@showWizard" IsOpenChanged="@(val => showWizard = val)" />
    <PlannerEntitiesModal @ref="entitiesModal" />
    <NewCustomerModal @ref="newCustomerModal" OnCustomerCreated="HandleNewCustomer" />

</div>
</CascadingValue>

@code {
    private bool showWizard;
    private bool _subscribed;

    private PlannerEntitiesModal? entitiesModal;
    private PlannerMap? mapRef;
    private NewCustomerModal? newCustomerModal;

    protected override async Task OnInitializedAsync() {
        if (_subscribed) return;

        DataCenter.CollectionChanged += OnCollectionChanged;
        await EnsureTenantInitializedAsync();

        _subscribed = true;
    }

    protected override async Task OnParametersSetAsync()
    {
        if (_subscribed)
            await EnsureTenantInitializedAsync();
    }

    private async Task EnsureTenantInitializedAsync()
    {
        if (!TokenStore.IsAuthenticated || string.IsNullOrWhiteSpace(TokenStore.AccessToken))
            return;

        var tokenTenantId = TokenStore.AccessToken.GetTenantId();
        if (tokenTenantId is null)
            return;

        if (DataCenter.TenantId != tokenTenantId.Value)
            DataCenter.Reset();

        await DataCenter.InitializeAsync(tokenTenantId.Value);
    }

    private async void OnCollectionChanged(string _) {
        await InvokeAsync(StateHasChanged);
    }

    private void OpenTab(string tab) {
        entitiesModal?.OpenTab(tab);
    }

    private Task JobPositionPicked(MapPosition args) {
        newCustomerModal?.Open(args);
        return Task.CompletedTask;
    }

    private async Task HandleNewCustomer(CustomerInput customer) {
        // UI no longer mutates state directly.
        // Customer creation must go through API.
        // For now: reload reference data.

        // await DataCenter.LoadCustomersAsync();
    }

    public void Dispose() {
        DataCenter.CollectionChanged -= OnCollectionChanged;
    }
}
