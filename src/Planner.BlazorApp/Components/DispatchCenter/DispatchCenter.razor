@page "/dispatch-center"
@rendermode InteractiveServer

@using static Microsoft.AspNetCore.Components.Web.RenderMode
@using Planner.BlazorApp.Auth
@using Planner.BlazorApp.Components.DispatchCenter
@using Planner.BlazorApp.State
@using Planner.BlazorApp.State.Interfaces
@using Planner.BlazorApp.WelcomeWizard
@using Planner.BlazorApp.PlannerEntitiesModal
@using Planner.BlazorApp.FormModels
@using Planner.BlazorApp.Services
@using Planner.Contracts.API

@inject ICustomerState CustomerState
@inject WizardService Wizard
@inject IJwtTokenStore TokenStore
@inject ITenantState TenantState
@inject NavigationManager Nav

@namespace Planner.BlazorApp.DispatchCenter

<div class="planner-view d-flex flex-column flex-fill">
    <!-- Top toolbar -->
    <div class="toolbar p-2 d-flex align-items-center bg-light border-bottom">
        <div class="d-flex gap-2">
            <button class="btn btn-info" @onclick="ShowWelcomeGuide">Show Welcome Guide</button>
            @if (TokenStore.IsAuthenticated && TokenStore.AccessToken!.GetRole() == "Admin") {
                <button class="btn btn-primary" @onclick=@(() => OpenTab("Customers"))>Planning Wizard</button>
            }
        </div>
        <h5 class="ms-auto mb-0">@(TenantState.TenantInfo?.TenantName ?? "Dispatch Centre")</h5>
    </div>

    <!-- Map area -->
    <div class="planner-map-area flex-fill position-relative">
        <PlannerMap @ref="mapRef" JobPositionPicked="JobPositionPicked"/>
    </div>

    <WelcomeWizardModal />
    <PlannerEntitiesModal @ref="entitiesModal" />
    <NewCustomerModal @ref="newCustomerModal" OnCustomerCreated="HandleNewCustomer" />

</div>

@code {
    private bool _subscribed;

    private PlannerEntitiesModal? entitiesModal;
    private PlannerMap? mapRef;
    private NewCustomerModal? newCustomerModal;

    protected override async Task OnInitializedAsync() {
        if (!TokenStore.IsAuthenticated || string.IsNullOrWhiteSpace(TokenStore.AccessToken))
        {
            Nav.NavigateTo("/login");
            return;
        }
        if (_subscribed) return;
        await CustomerState.InitializeAsync();
        _subscribed = true;
    }

    private async void OnCollectionChanged(string _) {
        await InvokeAsync(StateHasChanged);
    }

    private void OpenTab(string tab) {
        entitiesModal?.OpenTab(tab);
    }

    private void ShowWelcomeGuide() {
        Wizard.Open(startStep: 0);
    }

    private Task JobPositionPicked(MapPosition args) {
        newCustomerModal?.Open(args);
        return Task.CompletedTask;
    }

    private async Task HandleNewCustomer(CustomerFormModel customer) {
        await CustomerState.SaveChangesAsync([customer]);
    }
}
