@page "/dispatch-center"
@rendermode InteractiveServer

@using Microsoft.AspNetCore.Components.Authorization
@using Planner.BlazorApp.Auth
@using Planner.BlazorApp.Components.DispatchCenter
@using Planner.BlazorApp.Components.DispatchCenter.Models
@using Planner.BlazorApp.Components.WelcomeWizard
@using Planner.BlazorApp.FormModels
@using Planner.BlazorApp.Services
@using Planner.BlazorApp.State
@using Planner.BlazorApp.State.Interfaces
@using Planner.Contracts.API
@using static Microsoft.AspNetCore.Components.Web.RenderMode
@using Planner.BlazorApp.Components.Auth

@inject ICustomerState CustomerState
@inject ITenantState TenantState
@inject NavigationManager Nav
@inject WizardService Wizard
@inject AuthenticationStateProvider AuthProvider

<div class="planner-view d-flex flex-column flex-fill">
    <!-- Top toolbar -->
    <div class="toolbar p-2 d-flex align-items-center bg-light border-bottom">
        <div class="d-flex gap-2">
            <button class="btn btn-info" @onclick="ShowWelcomeGuide">Show Welcome Guide</button>
            <button class="btn btn-primary" @onclick=@(() => OpenTab("Customers"))>Planning Wizard</button>
        </div>
        <div class="ms-auto mb-0">
            <AuthorizeView>
                <Authorized>
                    <span>@(TenantState.TenantInfo?.TenantName ?? "Dispatch Centre") </span>
                    <a href="/MicrosoftIdentity/Account/SignOut">Log out</a>
                </Authorized>
                <NotAuthorized>
                    @* Show a button to open the modal instead of the direct login link *@
                    <button class="btn btn-primary" @onclick="() => showDemoModal = true">
                        Explore Demo
                    </button>
                </NotAuthorized>
            </AuthorizeView>
        </div>
        <DemoLoginModal IsVisible="showDemoModal" />
    </div>

    <!-- Map area -->
    <div class="planner-map-area flex-fill position-relative">
        <PlannerMap @ref="mapRef" JobPositionPicked="JobPositionPicked"/>
    </div>

    <WelcomeWizardModal />
    <PlannerEntitiesModal @ref="entitiesModal" />
    <NewCustomerModal @ref="newCustomerModal" OnCustomerCreated="HandleNewCustomer" />

</div>

@code {
    private bool _subscribed;
    private bool showDemoModal = false;

    private PlannerEntitiesModal? entitiesModal;
    private PlannerMap? mapRef;
    private NewCustomerModal? newCustomerModal;

    protected override async Task OnInitializedAsync() {
        var authState = await AuthProvider.GetAuthenticationStateAsync();

        // Only call the API if we actually have a logged-in user!
        if (authState.User.Identity?.IsAuthenticated == true) {
            if (_subscribed) return;
            await CustomerState.InitializeAsync();
            _subscribed = true;
        }
    }

    private async void OnCollectionChanged(string _) {
        await InvokeAsync(StateHasChanged);
    }

    private void OpenTab(string tab) {
        entitiesModal?.OpenTab(tab);
    }

    private void ShowWelcomeGuide() {
        Wizard.Open(startStep: 0);
    }

    private Task JobPositionPicked(MapPosition args) {
        newCustomerModal?.Open(args);
        return Task.CompletedTask;
    }

    private async Task HandleNewCustomer(CustomerFormModel customer) {
        await CustomerState.SaveChangesAsync(new[] { customer });
    }
}
