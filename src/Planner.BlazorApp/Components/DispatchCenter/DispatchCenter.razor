@page "/"
@rendermode InteractiveServer

@using Planner.BlazorApp.Models
@using Planner.BlazorApp.Components.WelcomeWizard
@using Planner.BlazorApp.Services
@using Planner.Contracts.Optimization.Inputs

@inject DataCenterState DataCenter
@inject IConfiguration Configuration

<CascadingValue Value="DataCenter">
<div class="planner-view d-flex flex-column flex-fill">
    <!-- Top toolbar -->
    <div class="toolbar p-2 d-flex align-items-center bg-light border-bottom">
        <div class="d-flex gap-2">
            <button class="btn btn-info" @onclick=@(() => showWizard = true)>Show Welcome Guide</button>
            <button class="btn btn-primary" @onclick=@(() => OpenTab("Customers"))>Optimization Wizard</button>
        </div>
        <h5 class="ms-auto mb-0">Dispatch Centre</h5>
    </div>

    <!-- Map area -->
    <div class="planner-map-area flex-fill position-relative">
        @if (DataCenter.Depots?.Count > 0)
        {
            <PlannerMap @ref="mapRef"
                        DepotLat="@DataCenter.Depots[0].Location.Latitude"
                        DepotLon="@DataCenter.Depots[0].Location.Longitude"
                        JobPositionPicked="JobPositionPicked"
                        Routes="@DataCenter.MapRoutes"
                        Customers="@DataCenter.MapCustomers" />
        }
        else
        {
            <!-- Loading state or default depot coordinates -->
            <PlannerMap @ref="mapRef"
                        DepotLat="-31.953823"
                        DepotLon="115.876140"
                        JobPositionPicked="JobPositionPicked"
                        Routes="@DataCenter.MapRoutes"
                        Customers="@DataCenter.MapCustomers" />
        }
    </div>

    <WelcomeWizardModal IsOpen="@showWizard" IsOpenChanged="@(val => showWizard = val)" />
    <PlannerEntitiesModal @ref="entitiesModal" />
    <NewCustomerModal @ref="newCustomerModal" OnCustomerCreated="HandleNewCustomer" />

</div>
</CascadingValue>

@code {
    private bool showWizard;
    private bool _subscribed;

    private PlannerEntitiesModal? entitiesModal;
    private PlannerMap? mapRef;
    private NewCustomerModal? newCustomerModal;

    private static readonly Guid TenantId =
        Guid.Parse("07B6C438-8B21-4B11-A0F3-9CFD1A2711FC"); // TEMP until auth

    protected override async Task OnInitializedAsync() {
        if (_subscribed) return;

        DataCenter.CollectionChanged += OnCollectionChanged;
        await DataCenter.InitializeAsync(TenantId);

        _subscribed = true;
    }

    private async void OnCollectionChanged(string _) {
        await InvokeAsync(StateHasChanged);
    }

    private void OpenTab(string tab) {
        entitiesModal?.OpenTab(tab);
    }

    private Task JobPositionPicked(MapPosition args) {
        newCustomerModal?.Open(args);
        return Task.CompletedTask;
    }

    private async Task HandleNewCustomer(CustomerInput customer) {
        // UI no longer mutates state directly.
        // Customer creation must go through API.
        // For now: reload reference data.

        // await DataCenter.LoadCustomersAsync();
    }

    public void Dispose() {
        DataCenter.CollectionChanged -= OnCollectionChanged;
    }
}
