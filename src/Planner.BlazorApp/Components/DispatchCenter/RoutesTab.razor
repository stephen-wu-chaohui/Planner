@using Planner.BlazorApp.Services
@using Planner.Contracts.Optimization.Outputs

<div class="planner-tab-wrapper">
    <div class="table-scroll">
        <table class="polished-table table table-sm table-bordered align-middle">
                <thead class="table-light">
                    <tr>
                        <th class="sticky-col">Vehicle</th>
                        <th>Jobs Served</th>
                        <th>Distance (km)</th>
                        <th>Duration (min)</th>
                        <th>Cost</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var r in Routes) {
                        <tr class="vehicle-row @(!r.Used ? "text-muted" : "")">
                            <td><strong>@r.VehicleName</strong></td>
                            <td>@r.Stops.Count</td>
                            <td>@($"{r.TotalDistanceKm:F1}")</td>
                            <td>@($"{r.TotalMinutes:F0}")</td>
                            <td>@($"{r.TotalCost:F2}")</td>
                        </tr>
                        @if (r.Stops.Any()) {
                            <tr>
                                <td colspan="5" class="p-0">
                                    <table class="table table-sm mb-0">
                                        <thead class="table-secondary">
                                            <tr>
                                                <th>#</th>
                                                <th>Job</th>
                                                <th>Type</th>
                                                <th>Arrival</th>
                                                <th>Departure</th>
                                                <th>Pallets</th>
                                                <th>Weight</th>
                                                <th>Refrig</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @for (int i = 0; i < r.Stops.Count; i++) {
                                                var s = r.Stops[i];
                                                <tr>
                                                    <td>@(i + 1)</td>
                                                    <td>@s.Name</td>
                                                    <td>@s.JobType</td>
                                                    <td>@Readble(s.ArrivalTime)</td>
                                                    <td>@Readble(s.DepartureTime)</td>
                                                    <td>@s.PalletLoad</td>
                                                    <td>@s.WeightLoad</td>
                                                    <td>@s.RefrigeratedLoad</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
    </div>

    <!-- FIXED ACTION BAR -->
    <div class="planner-tab-actions d-flex justify-content-between align-items-center">
        <button class="btn btn-outline-success" @onclick="SolveVrp">🧮 Solve VRP</button>
        @if (Routes.Count == 0) {
            <div class="alert alert-info mb-0">
                No routes available. Run <strong>“Solve VRP”</strong> to generate routes.
            </div>
        }
    </div>
</div>

@code {
    [Parameter] public List<RouteResult> Routes { get; set; } = new();

    [CascadingParameter] public DataCenterState? DataCenter { get; set; }

    private async Task SolveVrp()
    {
        if (DataCenter != null)
        {
            await DataCenter.SolveVrp();
        }
    }

    private string Readble(double minutesFromStart)
    {
        var startTime = new DateTime(2025, 1, 1, 8, 30, 0); // 8:30 AM
        var arrival = startTime.AddMinutes(minutesFromStart);
        return arrival.ToString("hh:mm tt");
    }
}
