@using Planner.BlazorApp.FormModels
@using Planner.BlazorApp.State.Interfaces
@using Planner.Contracts.Optimization.Requests
@using Planner.BlazorApp.Services
@using Planner.Contracts.API

@inject ICustomerState CustomerState
@inject IJobState JobState


<div class="planner-tab-wrapper">
    <div class="table-scroll">
        <table class="polished-table">
            <thead>
                <tr>
                    <th>Customer</th>
                    <th>Type</th>
                    <th>Ready</th>
                    <th>Due</th>
                    <th>Service (min)</th>
                    <th>Pallets</th>
                    <th>Weight</th>
                    <th>Refrig</th>
                    <th style="width:100px;"></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var j in Jobs) {
                    <tr class="@j.GetRowClass()" @key="j.JobId">
                        <td>@j.Name</td>
                        <td>@(j.JobType == 1 ? "Delivery" : "Pickup")</td>
                        <td>@j.ReadyTime</td>
                        <td>@j.DueTime</td>
                        <td>@j.ServiceTimeMinutes</td>
                        <td>@j.PalletDemand</td>
                        <td>@j.WeightDemand</td>
                        <td>@j.RequiresRefrigeration</td>
                        <td class="actions">
                            <button class="btn btn-sm btn-outline-secondary me-1" @onclick="@(() => Edit(j))">✏️</button>
                            <button class="btn btn-sm btn-outline-danger" @onclick="@(() => Delete(j))">🗑️</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="planner-tab-actions">
        <div class="actions-left">
            <button class="btn btn-sm btn-success me-1" @onclick="CreateJobsForAllCustomers">👥 Build</button>
            <button class="btn btn-sm btn-success me-1" @onclick="AddNew">➕ Add</button>
            <button class="btn btn-sm btn-primary me-1" @onclick="Save">Save Changes</button>
            <button class="btn btn-sm btn-outline-danger me-1" @onclick="Discard">🧹 Discard</button>
        </div>
        <div class="actions-right">
            <small class="text-muted">Define today's pickup / delivery jobs</small>
        </div>
    </div>
</div>

@if (Editing is not null) {
    <div class="modal fade show d-block" tabindex="-1"
         style="background-color:rgba(0,0,0,.4); z-index:1060;">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@((IsNew ? "Add" : "Edit") + " Job")</h5>
                    <button type="button" class="btn-close" @onclick="CloseEditModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-2">
                        <label class="form-label">Name</label>
                        <input class="form-control" @bind="Editing.Name" />
                    </div>

                    <div class="mb-2">
                        <label class="form-label">Job Type</label>
                        <select class="form-select" @bind="Editing.JobType">
                            <option value="1">Delivery</option>
                            <option value="2">Pickup</option>
                        </select>
                    </div>

                    <div class="row mb-2">
                        <div class="col">
                            <label class="form-label">Ready Time</label>
                            <input class="form-control" type="number" @bind="Editing.ReadyTime" />
                        </div>
                        <div class="col">
                            <label class="form-label">Due Time</label>
                            <input class="form-control" type="number" @bind="Editing.DueTime" />
                        </div>
                        <div class="col">
                            <label class="form-label">Service</label>
                            <input class="form-control" type="number" @bind="Editing.ServiceTimeMinutes" />
                        </div>
                    </div>

                    <div class="row mb-2">
                        <div class="col">
                            <label class="form-label">Pallets</label>
                            <input class="form-control" type="number" @bind="Editing.PalletDemand" />
                        </div>
                        <div class="col">
                            <label class="form-label">Weight</label>
                            <input class="form-control" type="number" @bind="Editing.WeightDemand" />
                        </div>
                        <div class="col">
                            <label class="form-label">Refrigerated</label>
                            <input class="form-control" type="checkbox" @bind="Editing.RequiresRefrigeration" />
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseEditModal">Cancel</button>
                    <button class="btn btn-primary" @onclick="SaveEdit">Save</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<JobFormModel> Jobs = new();
    private List<CustomerFormModel> Customers = new();

    private JobFormModel? Editing;
    private bool IsNew;

    protected override Task OnInitializedAsync() {
        Jobs = JobState.Jobs.Select(job => job.ToFormModel()).ToList();
        Customers = CustomerState.Customers.Select(c => c.ToFormModel()).ToList();
        JobState.OnJobsChanged += HandleJobsChanged;
        CustomerState.OnCustomersChanged += HandleCustomersChanged;

        return Task.CompletedTask;
    }

    private void HandleJobsChanged() {
        Jobs = JobState.Jobs.Select(job => job.ToFormModel()).ToList();
        InvokeAsync(StateHasChanged);
    }

    private void HandleCustomersChanged() {
        Customers = CustomerState.Customers.Select(c => c.ToFormModel()).ToList();
        InvokeAsync(StateHasChanged);
    }

    private void AddNew() {
        Editing = new JobFormModel {
            IsDirty = true,
            JobId = GetNextTemporaryJobId(),
            JobType = 1,
            Name = "",
            Latitude = 0,
            Longitude = 0,
            LocationId = Customers.First().LocationId,
            ServiceTimeMinutes = 30,
            ReadyTime = 0,
            DueTime = 480,
            PalletDemand = 1,
            WeightDemand = 50,
            RequiresRefrigeration = false
        };

        IsNew = true;
    }

    private void Edit(JobFormModel j) {
        Editing = new JobFormModel(j);
        Editing.IsDirty = true;
        IsNew = false;
    }

    private void SaveEdit() {
        if (Editing is null)
            return;

        if (IsNew) {
            Jobs.Add(Editing);
        } else {
            var index = Jobs.FindIndex(j => j.JobId == Editing.JobId);
            if (index >= 0)
                Jobs[index] = Editing;
        }

        Editing = null;
    }

    private void CloseEditModal() => Editing = null;


    private async Task Delete(JobFormModel job) {
        job.PendingDeletion = !job.PendingDeletion;
        await Task.CompletedTask;
    }

    private bool HasChanges => Jobs.Any(j => j.IsDirty || j.PendingDeletion);
    private async Task Save() {
        await JobState.SaveChangesAsync(Jobs);
    }

    private void Discard() {
        HandleJobsChanged();
    }

    private Task CreateJobsForAllCustomers(MouseEventArgs args)
    {
        throw new NotImplementedException();
    }

    /// <summary>
    /// Temporary JobID counter for new jobs
    /// </summary>
    private int TemporaryJobIdCounter = -1;

    private int GetNextTemporaryJobId() {
        return TemporaryJobIdCounter--;
    }
}
