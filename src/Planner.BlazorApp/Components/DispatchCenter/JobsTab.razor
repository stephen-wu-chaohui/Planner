@using Planner.Contracts.Messages.VehicleRoutingProblem
@using Planner.Domain.Entities
<div class="planner-tab-wrapper">
    <div class="table-scroll">
        <table class="polished-table">
            <thead>
                <tr>
                    <th class="sticky-col">ID</th>
                    <th>Customer</th>
                    <th>Type</th>
                    <th>Ready</th>
                    <th>Due</th>
                    <th>Service (min)</th>
                    <th>Pallets</th>
                    <th>Weight</th>
                    <th>Refrig</th>
                    <th>Vehicle Pref.</th>
                    <th style="width:100px;"></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var j in Jobs) {
                    <tr>
                        <td>@j.Id</td>
                        <td>@CustomerName(j.CustomerId)</td>
                        <td>@j.Type</td>
                        <td>@j.ReadyTime</td>
                        <td>@j.DueTime</td>
                        <td>@j.ServiceMinutes</td>
                        <td>@j.PalletDemand</td>
                        <td>@j.WeightDemand</td>
                        <td>@j.RefrigeratedRequirement</td>
                        <td>@VehicleName(j.VehiclePreference)</td>
                        <td class="actions">
                            <button class="btn btn-sm btn-outline-secondary me-1" @onclick="@(() => Edit(j))">✏️</button>
                            <button class="btn btn-sm btn-outline-danger" @onclick="@(() => Delete(j))">🗑️</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="planner-tab-actions">
        <div class="actions-left">
            <button class="btn btn-sm btn-success me-1" @onclick="CreateJobsForAllCustomers">👥 Build</button>
            <button class="btn btn-sm btn-success me-1" @onclick="AddNew">➕ Add</button>
            <button class="btn btn-sm btn-outline-danger me-1" @onclick="ClearAll">🧹 Clear</button>
            <button class="btn btn-sm btn-outline-success" @onclick="OnSolve">🧮 Solve VRP</button>
        </div>
        <div class="actions-right">
            <small class="text-muted">Define today's pickup / delivery jobs</small>
        </div>
    </div>
</div>

<!-- Edit Job Modal -->
@if (Editing is not null) {
    <div class="modal fade show d-block" tabindex="-1"
         style="background-color:rgba(0,0,0,.4); z-index:1060;">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@((IsNew ? "Add" : "Edit") + " Job")</h5>
                    <button type="button" class="btn-close" @onclick="CloseEditModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-2">
                        <label class="form-label">Customer</label>
                        <select class="form-select" @bind="Editing.CustomerId">
                            @foreach (var c in Customers) {
                                <option value="@c.Id">@c.Name</option>
                            }
                        </select>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Job Type</label>
                        <select class="form-select" @bind="Editing.Type">
                            <option value="@JobType.Delivery">Delivery</option>
                            <option value="@JobType.Pickup">Pickup</option>
                        </select>
                    </div>
                    <div class="row mb-2">
                        <div class="col">
                            <label class="form-label">Ready Time (min)</label>
                            <input class="form-control" type="number" @bind="Editing.ReadyTime" />
                        </div>
                        <div class="col">
                            <label class="form-label">Due Time (min)</label>
                            <input class="form-control" type="number" @bind="Editing.DueTime" />
                        </div>
                        <div class="col">
                            <label class="form-label">Service (min)</label>
                            <input class="form-control" type="number" @bind="Editing.ServiceMinutes" />
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col">
                            <label class="form-label">Pallets</label>
                            <input class="form-control" type="number" @bind="Editing.PalletDemand" />
                        </div>
                        <div class="col">
                            <label class="form-label">Weight</label>
                            <input class="form-control" type="number" @bind="Editing.WeightDemand" />
                        </div>
                        <div class="col">
                            <label class="form-label">Refrig</label>
                            <input class="form-control" type="number" @bind="Editing.RefrigeratedRequirement" />
                        </div>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Preferred Vehicle (optional)</label>
                        <select class="form-select" @bind="Editing.VehiclePreference">
                            <option value="">(Any)</option>
                            @foreach (var v in Vehicles) {
                                <option value="@v.Id">@v.Name</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseEditModal">Cancel</button>
                    <button class="btn btn-primary" @onclick="SaveEdit">Save</button>
                </div>
            </div>
        </div>
    </div>
}


@code {
    [Parameter] public bool Visible { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }

    [Parameter] public List<Job> Jobs { get; set; } = new();
    [Parameter] public List<Customer> Customers { get; set; } = new();
    [Parameter] public List<Vehicle> Vehicles { get; set; } = new();

    // fired when "Solve VRP" clicked
    [Parameter] public EventCallback OnSolve { get; set; }

    private Job? Editing;
    private bool IsNew;

    protected override async Task OnInitializedAsync()
    {
        if (Customers?.Count > 0 && Jobs.Count == 0)
        {
            await CreateJobsForAllCustomers();
        }
    }


    private async Task CreateJobsForAllCustomers() {
        if (Customers == null || Customers.Count == 0) {
            Console.WriteLine("No customers available to create jobs.");
            return;
        }

        Jobs.Clear();

        foreach (var c in Customers) {
            // Example: auto-generate one job per customer
            var job = new Job {
                Id = NextId(),
                Name = c.Name,
                CustomerId = c.Id,
                Type = JobType.Delivery,
                ReadyTime = 0,
                DueTime = 480,
                ServiceMinutes = 10,
                PalletDemand = 2,
                WeightDemand = 100,
                RefrigeratedRequirement = 0
            };
            Jobs.Add(job);
        }
        Console.WriteLine($"{Customers.Count} jobs created automatically.");
    }

    private void AddNew() {
        Editing = new Job {
            Id = NextId(),
            Type = JobType.Delivery,
            ReadyTime = 0,
            DueTime = 480,
            ServiceMinutes = 30,
            PalletDemand = 2,
            WeightDemand = 100,
            RefrigeratedRequirement = 0
        };
        IsNew = true;
    }

    private void Edit(Job j) {
        Editing = new Job {
            Id = j.Id,
            CustomerId = j.CustomerId,
            Type = j.Type,
            ReadyTime = j.ReadyTime,
            DueTime = j.DueTime,
            ServiceMinutes = j.ServiceMinutes,
            PalletDemand = j.PalletDemand,
            WeightDemand = j.WeightDemand,
            RefrigeratedRequirement = j.RefrigeratedRequirement,
            VehiclePreference = j.VehiclePreference
        };
        IsNew = false;
    }

    private void CloseEditModal() => Editing = null;

    private void SaveEdit() {
        if (Editing is null) return;

        if (IsNew)
            Jobs.Add(Editing);
        else {
            var existing = Jobs.FirstOrDefault(x => x.Id == Editing.Id);
            if (existing is not null) {
                existing.CustomerId = Editing.CustomerId;
                existing.Type = Editing.Type;
                existing.ReadyTime = Editing.ReadyTime;
                existing.DueTime = Editing.DueTime;
                existing.ServiceMinutes = Editing.ServiceMinutes;
                existing.PalletDemand = Editing.PalletDemand;
                existing.WeightDemand = Editing.WeightDemand;
                existing.RefrigeratedRequirement = Editing.RefrigeratedRequirement;
                existing.VehiclePreference = Editing.VehiclePreference;
            }
        }
        Editing = null;
    }

    private void Delete(Job j) => Jobs.Remove(j);
    private void ClearAll() => Jobs.Clear();

    private string CustomerName(int id) =>
        Customers.FirstOrDefault(c => c.Id == id)?.Name ?? "(none)";

    private string VehicleName(int? id) =>
        id is null ? "(any)" : Vehicles.FirstOrDefault(v => v.Id == id)?.Name ?? "(?)";

    private int NextId() => Jobs.Count == 0 ? 0 : Jobs.Max(j => j.Id) + 1;
}


