@using Planner.Contracts.Optimization.Requests
@using Planner.BlazorApp.Forms

<div class="planner-tab-wrapper">
    <div class="table-scroll">
        <table class="polished-table">
            <thead>
                <tr>
                    <th class="sticky-col">ID</th>
                    <th>Customer</th>
                    <th>Type</th>
                    <th>Ready</th>
                    <th>Due</th>
                    <th>Service (min)</th>
                    <th>Pallets</th>
                    <th>Weight</th>
                    <th>Refrig</th>
                    <th style="width:100px;"></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var j in Jobs) {
                    <tr>
                        <td>@j.JobId</td>
                        <td>@j.Name</td>
                        <td>@(j.JobType == 1 ? "Delivery" : "Pickup")</td>
                        <td>@j.ReadyTime</td>
                        <td>@j.DueTime</td>
                        <td>@j.ServiceTimeMinutes</td>
                        <td>@j.PalletDemand</td>
                        <td>@j.WeightDemand</td>
                        <td>@j.RequiresRefrigeration</td>
                        <td class="actions">
                            <button class="btn btn-sm btn-outline-secondary me-1" @onclick="@(() => Edit(j))">✏️</button>
                            <button class="btn btn-sm btn-outline-danger" @onclick="@(() => Delete(j))">🗑️</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="planner-tab-actions">
        <div class="actions-left">
            <button class="btn btn-sm btn-success me-1" @onclick="CreateJobsForAllCustomers">👥 Build</button>
            <button class="btn btn-sm btn-success me-1" @onclick="AddNew">➕ Add</button>
            <button class="btn btn-sm btn-outline-danger me-1" @onclick="ClearAll">🧹 Clear</button>
        </div>
        <div class="actions-right">
            <small class="text-muted">Define today's pickup / delivery jobs</small>
        </div>
    </div>
</div>

@if (Editing is not null) {
    <div class="modal fade show d-block" tabindex="-1"
         style="background-color:rgba(0,0,0,.4); z-index:1060;">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@((IsNew ? "Add" : "Edit") + " Job")</h5>
                    <button type="button" class="btn-close" @onclick="CloseEditModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-2">
                        <label class="form-label">Customer</label>
                        <select class="form-select" @bind="editingLocationId">
                            @foreach (var c in Customers) {
                                <option value="@c.LocationId">@c.Name</option>
                            }
                        </select>
                    </div>

                    <div class="mb-2">
                        <label class="form-label">Job Type</label>
                        <select class="form-select" @bind="editingJobType">
                            <option value="1">Delivery</option>
                            <option value="2">Pickup</option>
                        </select>
                    </div>

                    <div class="row mb-2">
                        <div class="col">
                            <label class="form-label">Ready Time</label>
                            <input class="form-control" type="number" @bind="editingReady" />
                        </div>
                        <div class="col">
                            <label class="form-label">Due Time</label>
                            <input class="form-control" type="number" @bind="editingDue" />
                        </div>
                        <div class="col">
                            <label class="form-label">Service</label>
                            <input class="form-control" type="number" @bind="editingService" />
                        </div>
                    </div>

                    <div class="row mb-2">
                        <div class="col">
                            <label class="form-label">Pallets</label>
                            <input class="form-control" type="number" @bind="editingPallets" />
                        </div>
                        <div class="col">
                            <label class="form-label">Weight</label>
                            <input class="form-control" type="number" @bind="editingWeight" />
                        </div>
                        <div class="col">
                            <label class="form-label">Refrigerated</label>
                            <input class="form-control" type="checkbox" @bind="editingRefrig" />
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseEditModal">Cancel</button>
                    <button class="btn btn-primary" @onclick="SaveEdit">Save</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public List<JobFormModel> Jobs { get; set; } = new();
    [Parameter] public List<CustomerFormModel> Customers { get; set; } = new();
    [Parameter] public List<Vehicle> Vehicles { get; set; } = new();
    [Parameter] public EventCallback OnSolve { get; set; }

    private JobFormModel? Editing;
    private bool IsNew;

    private long editingLocationId;
    private int editingJobType;
    private long editingReady;
    private long editingDue;
    private long editingService;
    private long editingPallets;
    private long editingWeight;
    private bool editingRefrig;

    protected override Task OnInitializedAsync() {
        if (Customers.Count > 0 && Jobs.Count == 0)
            return CreateJobsForAllCustomers();

        return Task.CompletedTask;
    }

    private JobFormModel CreateJobFromCustomer(CustomerFormModel c) =>
        new JobFormModel {
            JobId = NextId(),
            JobType = 1,
            LocationId = c.LocationId,
            Name = c.Name,
            Latitude = c.Latitude,
            Longitude = c.Longitude,
            ServiceTimeMinutes = c.DefaultServiceMinutes,
            RequiresRefrigeration = c.RequiresRefrigeration,
            ReadyTime = 0,
            DueTime = 480
        };

    private Task CreateJobsForAllCustomers() {
        Jobs.Clear();

        foreach (var c in Customers) {
            Jobs.Add(new JobFormModel {
                JobId = NextId(),
                JobType = 1,
                Name = c.Name,
                Latitude = c.Latitude,
                Longitude = c.Longitude,
                LocationId = c.LocationId,
                ServiceTimeMinutes = c.DefaultServiceMinutes,
                ReadyTime = 0,
                DueTime = 480,
                PalletDemand = 2,
                WeightDemand = 100,
                RequiresRefrigeration = c.RequiresRefrigeration
            });
        }

        return Task.CompletedTask;
    }

    private void AddNew() {
        Editing = new JobFormModel {
            JobId = NextId(),
            JobType = 1,
            Name = "",
            Latitude = 0,
            Longitude = 0,
            LocationId = Customers.First().LocationId,
            ServiceTimeMinutes = 30,
            ReadyTime = 0,
            DueTime = 480,
            PalletDemand = 1,
            WeightDemand = 50,
            RequiresRefrigeration = false
        };

        LoadEditingFields(Editing);
        IsNew = true;
    }

    private void Edit(JobFormModel j) {
        Editing = new JobFormModel {
            JobId = j.JobId,
            JobType = j.JobType,
            Name = j.Name,
            Latitude = j.Latitude,
            Longitude = j.Longitude,
            LocationId = j.LocationId,
            ReadyTime = j.ReadyTime,
            DueTime = j.DueTime,
            ServiceTimeMinutes = j.ServiceTimeMinutes,
            PalletDemand = j.PalletDemand,
            WeightDemand = j.WeightDemand,
            RequiresRefrigeration = j.RequiresRefrigeration
        };

        LoadEditingFields(Editing);
        IsNew = false;
    }

    private void LoadEditingFields(JobFormModel j) {
        editingLocationId = j.LocationId;
        editingJobType = j.JobType;
        editingReady = j.ReadyTime;
        editingDue = j.DueTime;
        editingService = j.ServiceTimeMinutes;
        editingPallets = j.PalletDemand;
        editingWeight = j.WeightDemand;
        editingRefrig = j.RequiresRefrigeration;
    }

    private void SaveEdit() {
        var customer = Customers.FirstOrDefault(c => c.LocationId == editingLocationId);

        Editing = new JobFormModel {
            JobId = Editing!.JobId,
            Name = customer?.Name ?? "Unknown",
            Latitude = customer?.Latitude ?? 0,
            Longitude = customer?.Longitude ?? 0,
            LocationId = editingLocationId,
            JobType = editingJobType,
            ReadyTime = editingReady,
            DueTime = editingDue,
            ServiceTimeMinutes = editingService,
            PalletDemand = editingPallets,
            WeightDemand = editingWeight,
            RequiresRefrigeration = editingRefrig
        };

        if (IsNew) {
            Jobs.Add(Editing);
        } else {
            var index = Jobs.FindIndex(j => j.JobId == Editing.JobId);
            if (index >= 0)
                Jobs[index] = Editing;
        }

        Editing = null;
    }

    private void CloseEditModal() => Editing = null;
    private void Delete(JobFormModel j) => Jobs.Remove(j);
    private void ClearAll() => Jobs.Clear();

    private int NextId() =>
        Jobs.Count == 0 ? 0 : Jobs.Max(j => j.JobId) + 1;
}
