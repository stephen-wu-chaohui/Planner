@using System.Text.Json
@using Planner.BlazorApp.FormModels
@using Planner.BlazorApp.Services
@using Planner.BlazorApp.State.Interfaces
@using Planner.Contracts.API

@inject ICustomerState CustomerState

<div class="planner-tab-wrapper">
    <div class="table-scroll">
        <table class="polished-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Address</th>
                    <th style="width:100px;"></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var c in Customers) {
                    <tr class="@c.GetRowClass()" @key="c.CustomerId">
                        <td>@c.Name</td>
                        <td>@c.Address</td>
                        <td class="actions">
                            <button class="btn btn-sm btn-outline-secondary me-1"
                                    @onclick="@(() => Edit(c))">
                                ✏️
                            </button>
                            <button class="btn btn-sm btn-outline-danger"
                                    @onclick="@(() => Delete(c))">
                                🗑️
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="planner-tab-actions d-flex justify-content-end p-2 border-top bg-light">
        <button class="btn btn-outline-secondary me-2" @onclick="Discard" disabled="@(!HasChanges || CustomerState.IsProcessing)">Discard</button>
        <button class="btn btn-primary" @onclick="Save" disabled="@(!HasChanges || CustomerState.IsProcessing)">
            @if(CustomerState.IsProcessing) { <span class="spinner-border spinner-border-sm me-1"></span> }
            Save Changes
        </button>
    </div>
</div>

@if (Editing is not null) {
    <div class="modal fade show d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@((IsNew ? "Add" : "Edit") + " Customer")</h5>
                    <button type="button" class="btn-close" @onclick="CloseEditModal"></button>
                </div>

                <div class="modal-body">
                    <div class="mb-2">
                        <label class="form-label">Name</label>
                        <input class="form-control" @bind="Editing.Name" />
                    </div>

                    <div class="mb-2">
                        <label class="form-label">Address</label>
                        <input class="form-control" @bind="Editing.Address" />
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseEditModal">Cancel</button>
                    <button class="btn btn-primary" @onclick="SaveEdit">OK</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<CustomerFormModel> Customers = new();

    protected override Task OnInitializedAsync() {
        Customers = CustomerState.Customers.Select(c => c.ToFormModel()).ToList();
        CustomerState.OnCustomersChanged += HandleCustomersChanged;
        return Task.CompletedTask;
    }

    private void HandleCustomersChanged()
    {
        Customers = CustomerState.Customers.Select(c => c.ToFormModel()).ToList();
        InvokeAsync(StateHasChanged);
    }

    private CustomerFormModel? Editing;
    private bool IsNew;

    public void OpenForNewCustomer(MapPosition pos) {
        Editing = new CustomerFormModel {
            IsDirty = true,
            CustomerId = GetNextTemporaryCustomerId(),
            LocationId = 0,
            Name = pos.Label,
            Address = pos.Address,
            Latitude = pos.Lat,
            Longitude = pos.Lng,
            DefaultServiceMinutes = 10,
            RequiresRefrigeration = false,
            DefaultJobType = 1
        };
        IsNew = true;
    }

    private void Edit(CustomerFormModel c) {
        Editing = new CustomerFormModel(c);
        Editing.IsDirty = true;
        IsNew = false;
    }

    private async Task SaveEdit() {
        if (Editing is null) 
            return;

        if (IsNew) {
            Customers.Add(Editing);
            IsNew = false;
        } else {
            var index = Customers.FindIndex(x => x.CustomerId == Editing.CustomerId);
            if (index >= 0) {
                Customers[index] = Editing;
            }
        }
        Editing = null;
        await Task.CompletedTask;
    }

    private void CloseEditModal() => Editing = null;

    private async Task Delete(CustomerFormModel c) {
        c.PendingDeletion = !c.PendingDeletion;
        await Task.CompletedTask;
    }

    private bool HasChanges => Customers.Any(c => c.IsDirty || c.PendingDeletion);

    private async Task Save() {
        await CustomerState.SaveChangesAsync(Customers);
    }

    private void Discard() {
        HandleCustomersChanged();
    }

    /// <summary>
    /// Temporary CustomerID counter for new customers
    /// </summary>
    private int TemporaryCustomerIdCounter = -1;

    private int GetNextTemporaryCustomerId() {
        return TemporaryCustomerIdCounter--;
    }
}
