@using System.Text.Json
@using Planner.BlazorApp.Forms
@using Planner.BlazorApp.Models
@using Planner.BlazorApp.Services
@using Planner.Contracts.API

<div class="planner-tab-wrapper">
    <div class="table-scroll">
        <table class="polished-table">
            <thead>
                <tr>
                    <th class="sticky-col">ID</th>
                    <th>Name</th>
                    <th>Default Job Type</th>
                    <th>Address</th>
                    <th style="width:100px;"></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var c in Customers) {
                    <tr>
                        <td>@c.CustomerId</td>
                        <td>@c.Name</td>
                        <td>@c.DefaultJobType</td>
                        <td>@c.Address</td>
                        <td class="actions">
                            <button class="btn btn-sm btn-outline-secondary me-1"
                                    @onclick="@(() => Edit(c))">
                                ✏️
                            </button>
                            <button class="btn btn-sm btn-outline-danger"
                                    @onclick="@(() => Delete(c))">
                                🗑️
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@if (Editing is not null) {
    <div class="modal fade show d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@((IsNew ? "Add" : "Edit") + " Customer")</h5>
                    <button type="button" class="btn-close" @onclick="CloseEditModal"></button>
                </div>

                <div class="modal-body">
                    <div class="mb-2">
                        <label class="form-label">Name</label>
                        <input class="form-control" @bind="Editing.Name" />
                    </div>

                    <div class="mb-2">
                        <label class="form-label">Address</label>
                        <input class="form-control" @bind="Editing.Address" />
                    </div>

                    <div class="mb-2">
                        <label class="form-label">Default Job Type</label>
                        <select class="form-select" @bind="Editing.DefaultJobType">
                            <option value="1">Delivery</option>
                            <option value="2">Pickup</option>
                        </select>
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseEditModal">Cancel</button>
                    <button class="btn btn-primary" @onclick="SaveEdit">Save</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [CascadingParameter] public DataCenterState? DataCenter { get; set; }
    private List<CustomerFormModel> Customers = new();

    protected override Task OnInitializedAsync() {
        if (DataCenter != null) {
            Customers = DataCenter.Customers.Select(c => c.ToFormModel()).ToList();
            DataCenter.OnCustomerChanged += OnCustomerChanged;
        }
        return Task.CompletedTask;
    }

    private async void OnCustomerChanged(DataChangedEventArgs<CustomerDto> args) {
        if (args.ChangeType == DataChangeType.Added) {
            Customers.Add(args.Item.ToFormModel());
        } else if (args.ChangeType == DataChangeType.Updated) {
            var index = Customers.FindIndex(c => c.CustomerId == args.Item.CustomerId);
            if (index >= 0) {
                Customers[index] = args.Item.ToFormModel();
            }
        } else if (args.ChangeType == DataChangeType.Deleted) {
            Customers.RemoveAll(c => c.CustomerId == args.Item.CustomerId);
        }
        await InvokeAsync(StateHasChanged);
    }

    private CustomerFormModel? Editing;
    private bool IsNew;

    public void OpenForNewCustomer(MapPosition pos) {
        Editing = new CustomerFormModel {
            CustomerId = NextId(),
            LocationId = NextLocationId(),
            Name = pos.Label,
            Address = pos.Address,
            Latitude = pos.Lat,
            Longitude = pos.Lng,
            DefaultServiceMinutes = 10,
            RequiresRefrigeration = false,
            DefaultJobType = 1
        };
        IsNew = true;
    }

    private void Edit(CustomerFormModel c) {
        Editing = c with { };
        IsNew = false;
    }

    private async Task SaveEdit() {
        if (Editing is null || DataCenter is null) 
            return;

        if (IsNew) {
            await DataCenter!.AddNewCustomerAsync(Editing);
        } else {
            var index = Customers.FindIndex(x => x.CustomerId == Editing.CustomerId);
            if (index >= 0)
            {
                await DataCenter!.UpdateCustomerAsync(Editing);
            }
        }
        Editing = null;
    }

    private void CloseEditModal() => Editing = null;

    private async Task Delete(CustomerFormModel c) {
        if (DataCenter is null)
            return;
        await DataCenter!.RemoveCustomerAsync(c);
    }


    private long NextId() =>
        Customers.Count == 0 ? 1 : Customers.Max(c => c.CustomerId) + 1;

    private long NextLocationId() =>
        Customers.Count == 0 ? 1 : Customers.Max(c => c.LocationId) + 1;
}
