@using Microsoft.JSInterop
@using Planner.BlazorApp.FormModels
@using Planner.BlazorApp.Services
@using Planner.BlazorApp.State.Interfaces
@using Planner.Contracts.API

@inject IJSRuntime JS
@inject IConfiguration Config
@inject ILogger<PlannerMap> Logger
@inject ICustomerState CustomerState
@inject IRouteState RouteState
@inject ITenantState TenantState

@implements IAsyncDisposable

<div class="map-wrapper position-relative" style="width:@Width; height:@Height;">
    <div id="map" class="map-canvas w-100 h-100"></div>

    @if (_showError)
    {
        <div class="map-error p-3 bg-warning text-dark position-absolute top-0 start-0 m-3 rounded">
            <strong>Map error:</strong> @_errorMessage
        </div>
    }
</div>

@code {
    [Parameter] public string Width { get; set; } = "100%";
    [Parameter] public string Height { get; set; } = "100%";
    [Parameter] public EventCallback<MapPosition> JobPositionPicked { get; set; }

    private List<CustomerMarker> customers = [];
    private List<MapRoute> routes = [];
    private DotNetObjectReference<PlannerMap>? dotNetRef;

    public ValueTask DisposeAsync() {
        dotNetRef?.Dispose();
        dotNetRef = null;
        return ValueTask.CompletedTask;
    }

    protected override void OnInitialized() {
        // 1. Subscribe to the event when the component initializes
        CustomerState.OnCustomersChanged += OnCustomersChanged;
        RouteState.OnRoutesChanged += OnRoutesChanged;
        TenantState.OnTenantInfoReady += OnTenantChanged;
    }

    private TaskCompletionSource<bool> _mapReadySource = new();

    private bool _showError;
    private string? _errorMessage;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            dotNetRef = DotNetObjectReference.Create(this);

            var apiKey = Config["GoogleMaps:ApiKey"];

            if (string.IsNullOrWhiteSpace(apiKey))
            {
                _showError = true;
                _errorMessage = "Google Maps API key is not configured. Set 'GoogleMaps:ApiKey' in configuration or launch settings.";
                Logger.LogWarning("Google Maps API key missing");
                StateHasChanged();
                return;
            }

            try
            {
                await JS.InvokeVoidAsync("loadGoogleMaps", apiKey);
                // Don't register click handler here - wait for map to be initialized in OnTenantChanged
                _mapReadySource.SetResult(true);
            }
            catch (JSException jsex)
            {
                _showError = true;
                _errorMessage = "Failed to load Google Maps script: " + jsex.Message;
                Logger.LogError(jsex, "Failed to initialize Google Maps");
                StateHasChanged();
            }
            catch (Exception ex)
            {
                _showError = true;
                _errorMessage = "Unexpected error initializing map: " + ex.Message;
                Logger.LogError(ex, "Unexpected error initializing map");
                StateHasChanged();
            }
        }
    }


    [JSInvokable]
    public Task OnMapClick(MapPosition position) {
        if (JobPositionPicked.HasDelegate) 
            JobPositionPicked.InvokeAsync(position);
        return Task.CompletedTask;
    }

    private async void OnCustomersChanged()
    {
        // Execution will PAUSE here until SetResult(true) is called above
        await _mapReadySource.Task;

        customers = CustomerState.Customers.Select(c => new CustomerMarker
        {
            Label = c.Name,
            Lat = c.Location.Latitude,
            Lng = c.Location.Longitude
        }).ToList();

        await JS.InvokeVoidAsync("plannerMap.updateCustomers", customers);
    }

    private async void OnRoutesChanged()
    {
        // Execution will PAUSE here until SetResult(true) is called above
        await _mapReadySource.Task;

        var routes = RouteState.MapRoutes;
        await JS.InvokeVoidAsync("plannerMap.updateRoutes", routes);
    }

    /// <summary>
    /// Updates the map center based on the selected tenant.
    /// </summary>
    private async void OnTenantChanged()
    {
        // Wait for Google Maps API to be loaded
        await _mapReadySource.Task;
        
        var mapCenter = TenantState.TenantInfo?.MainDepot?.Location ?? new LocationDto(Id: 0, Address: "Perth", Latitude: -31.9505, Longitude: 115.8605);
        var apiMapId = Config["GoogleMaps:MapId"];
        await JS.InvokeVoidAsync("plannerMap.initMap", mapCenter.Latitude, mapCenter.Longitude, apiMapId);
        
        // Now that the map is initialized, register the click handler
        if (dotNetRef is not null)
        {
            await JS.InvokeVoidAsync("plannerMap.registerClickHandler", dotNetRef, nameof(OnMapClick));
        }
    }

    /// <summary>
    /// //////////////////////////////
    /// </summary>
    /// 

    public async Task ClearRoutesAsync() {
        await JS.InvokeVoidAsync("plannerMap.clearRoutes");
    }

    public async Task AddMarkerAsync(CustomerMarker marker) =>
        await JS.InvokeVoidAsync("plannerMap.addMarker", marker);

    public async Task DrawRouteAsync(string routeName, string color, List<CustomerMarker> markers) =>
        await JS.InvokeVoidAsync("plannerMap.drawRoute", routeName, color, markers);

    public async Task HighlightRouteAsync(string routeName) =>
        await JS.InvokeVoidAsync("plannerMap.highlightRoute", routeName);

    public async Task ResetHighlightsAsync() =>
        await JS.InvokeVoidAsync("plannerMap.resetHighlights");

    public async Task FitToBoundsAsync() =>
        await JS.InvokeVoidAsync("plannerMap.fitToBounds");

}


