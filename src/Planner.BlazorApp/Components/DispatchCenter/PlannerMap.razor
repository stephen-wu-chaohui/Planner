@using Planner.Domain.Entities
@inject IJSRuntime JS
@inject IConfiguration Config
@inject ILogger<PlannerMap> Logger
@implements IDisposable

<div class="map-wrapper position-relative" style="width:@Width; height:@Height;">
    <div id="map" class="map-canvas w-100 h-100"></div>

    @if (_showError)
    {
        <div class="map-error p-3 bg-warning text-dark position-absolute top-0 start-0 m-3 rounded">
            <strong>Map error:</strong> @_errorMessage
        </div>
    }
</div>

@code {
    [Parameter] public string Width { get; set; } = "100%";
    [Parameter] public string Height { get; set; } = "100%";
    [Parameter] public double DepotLat { get; set; }
    [Parameter] public double DepotLon { get; set; }
    [Parameter] public IReadOnlyList<JobMarker>? Customers { get; set; }
    [Parameter] public IReadOnlyList<MapRoute>? Routes { get; set; }
    [Parameter] public EventCallback<MapPosition> JobPositionPicked { get; set; }

    private DotNetObjectReference<PlannerMap>? dotNetRef;

    private bool _initialized;
    public IReadOnlyList<JobMarker>? existingCustomers = null;
    public IReadOnlyList<MapRoute>? existingRoutes = null;

    private bool _showError;
    private string? _errorMessage;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            dotNetRef = DotNetObjectReference.Create(this);

            var apiKey = Config["GoogleMaps:ApiKey"];
            var apiMapId = Config["GoogleMaps:MapId"];

            if (string.IsNullOrWhiteSpace(apiKey))
            {
                _showError = true;
                _errorMessage = "Google Maps API key is not configured. Set 'GoogleMaps:ApiKey' in configuration or launch settings.";
                Logger.LogWarning("Google Maps API key missing");
                StateHasChanged();
                return;
            }

            try
            {
                await JS.InvokeVoidAsync("loadGoogleMaps", apiKey);
                await JS.InvokeVoidAsync("plannerMap.initMap", DepotLat, DepotLon, apiMapId);
                await JS.InvokeVoidAsync("plannerMap.registerClickHandler", dotNetRef, nameof(OnMapClick));

                _initialized = true;

                await OnParametersSetAsync();
            }
            catch (JSException jsex)
            {
                _showError = true;
                _errorMessage = "Failed to load Google Maps script: " + jsex.Message;
                Logger.LogError(jsex, "Failed to initialize Google Maps");
                StateHasChanged();
            }
            catch (Exception ex)
            {
                _showError = true;
                _errorMessage = "Unexpected error initializing map: " + ex.Message;
                Logger.LogError(ex, "Unexpected error initializing map");
                StateHasChanged();
            }
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (!_initialized) {
            return;
        }
        // if (Routes != existingRoutes && Routes != null)
        // {
        //     await JS.InvokeVoidAsync("plannerMap.updateRoutes", Routes);
        //     existingRoutes = Routes;
        // }
        // if (Customers != existingCustomers && Customers != null)
        // {
        //     await JS.InvokeVoidAsync("plannerMap.updateCustomers", Customers);
        //     existingCustomers = Customers;
        // }
    }

    [JSInvokable]
    public Task OnMapClick(MapPosition position) {
        if (JobPositionPicked.HasDelegate) 
            JobPositionPicked.InvokeAsync(position);
        return Task.CompletedTask;
    }

    public async Task ClearRoutes()
    {
        await JS.InvokeVoidAsync("plannerMap.clearRoutes");
    }

    public async Task ClearRoutesAsync()
    {
        await JS.InvokeVoidAsync("plannerMap.clearRoutes");
    }

    public async Task AddMarkerAsync(JobMarker marker) =>
        await JS.InvokeVoidAsync("plannerMap.addMarker", marker);

    public async Task DrawRouteAsync(string routeName, string color, List<JobMarker> markers) =>
        await JS.InvokeVoidAsync("plannerMap.drawRoute", routeName, color, markers);

    public async Task HighlightRouteAsync(string routeName) =>
        await JS.InvokeVoidAsync("plannerMap.highlightRoute", routeName);

    public async Task ResetHighlightsAsync() =>
        await JS.InvokeVoidAsync("plannerMap.resetHighlights");

    public async Task FitToBoundsAsync() =>
        await JS.InvokeVoidAsync("plannerMap.fitToBounds");

    /////////////////////////////////////////////////////////////////////////



    /// <summary>
    /// ///////////////////// Compute Distance Matrix /////////////////////
    /// </summary>
    /// <returns></returns>
    public async Task<double[][]> ComputeMatrix()
    {
        // Future: call mapInterop.getDistanceMatrix() or send Jobs to API
        return await JS.InvokeAsync<double[][]>("PlannerMap.getDistanceMatrix");
    }

    public class RouteDto
    {
        public string VehicleId { get; set; } = "";
        public List<RoutePoint> Points { get; set; } = new();
    }

    public class RoutePoint
    {
        public double Lat { get; set; }
        public double Lon { get; set; }
    }

    public class JobPoint
    {
        public string Id { get; set; } = "";
        public double Latitude { get; set; }
        public double Longitude { get; set; }
    }

    public void Dispose()
    {
        dotNetRef?.Dispose();
    }
}
