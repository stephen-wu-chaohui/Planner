@using Planner.Contracts.Messages.VehicleRoutingProblem

@if (Visible) {
    <div class="modal fade show d-block" tabindex="-1" role="dialog"
         style="background-color:rgba(0,0,0,.4);">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content shadow-lg">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">🗺️ Route Results</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="OnClose"></button>
                </div>

                <div class="modal-body">
                    @if (Routes.Count == 0) {
                        <div class="alert alert-info mb-0">
                            No routes available. Run <strong>“Solve VRP”</strong> in Jobs first.
                        </div>
                    } else {
                        <table class="table table-sm table-bordered align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Vehicle</th>
                                    <th>Jobs Served</th>
                                    <th>Distance (km)</th>
                                    <th>Duration (min)</th>
                                    <th>Cost</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var r in Routes) {
                                    <tr @onmouseenter="@(() => OnHighlight.InvokeAsync(r.VehicleName))"
                                        @onmouseleave="@(() => OnReset.InvokeAsync())"
                                        class="@(!r.Used ? "text-muted" : "")">
                                        <td><strong>@r.VehicleName</strong></td>
                                        <td>@r.Stops.Count</td>
                                        <td>@($"{r.DistanceKm:F1}")</td>
                                        <td>@($"{r.TotalMinutes:F0}")</td>
                                        <td>@($"{r.Cost:F2}")</td>
                                    </tr>
                                    @if (r.Stops.Any()) {
                                        <tr>
                                            <td colspan="5" class="p-0">
                                                <table class="table table-sm mb-0">
                                                    <thead class="table-secondary">
                                                        <tr>
                                                            <th>#</th>
                                                            <th>Job</th>
                                                            <th>Type</th>
                                                            <th>Arrival</th>
                                                            <th>Departure</th>
                                                            <th>Pallets</th>
                                                            <th>Weight</th>
                                                            <th>Refrig</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        @for (int i = 0; i < r.Stops.Count; i++) {
                                                            var s = r.Stops[i];
                                                            <tr>
                                                                <td>@(i + 1)</td>
                                                                <td>@s.JobName</td>
                                                                <td>@s.JobType</td>
                                                                <td>@s.ArrivalTime</td>
                                                                <td>@s.DepartureTime</td>
                                                                <td>@s.PalletLoad</td>
                                                                <td>@s.WeightLoad</td>
                                                                <td>@s.RefrigeratedLoad</td>
                                                            </tr>
                                                        }
                                                    </tbody>
                                                </table>
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    }
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="OnClose">Close</button>
                </div>
            </div>
        </div>
    </div>
}


@code {
    [Parameter] public bool Visible { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }

    [Parameter] public List<VehicleRoute> Routes { get; set; } = new();

    [Parameter] public EventCallback<string> OnHighlight { get; set; }
    [Parameter] public EventCallback OnReset { get; set; }
}
