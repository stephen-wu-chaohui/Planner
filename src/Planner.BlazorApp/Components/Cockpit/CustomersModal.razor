@using System.Text.Json
@using Planner.Contracts.Messages.VehicleRoutingProblem
@using Planner.Domain.Entities

@if (Visible) {
    <div class="modal fade show d-block" tabindex="-1"
         style="background-color:rgba(0,0,0,.4);"
         role="dialog">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content shadow-lg">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">👥 Customers</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="OnClose"></button>
                </div>

                <div class="modal-body">
                    <div class="d-flex justify-content-between mb-2">
                        <div>
                            <button class="btn btn-sm btn-success me-1" @onclick="AddNew">➕ Add</button>
                            <button class="btn btn-sm btn-outline-secondary me-1" @onclick="LoadFromFile">📂 Load</button>
                            <button class="btn btn-sm btn-outline-primary" @onclick="SaveToFile">💾 Save</button>
                        </div>
                        <small class="text-muted">Stored at: wwwroot/data/customers.json</small>
                    </div>

                    <table class="table table-sm table-bordered align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Address</th>
                                <th>Lat</th>
                                <th>Lng</th>
                                <th>Job Type</th>
                                <th style="width: 100px;"></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var c in Customers) {
                                <tr>
                                    <td>@c.Id</td>
                                    <td>@c.Name</td>
                                    <td>@c.Address</td>
                                    <td>@c.Latitude.ToString("F5")</td>
                                    <td>@c.Longitude.ToString("F5")</td>
                                    <td>@c.DefaultJobType</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-secondary me-1" @onclick="@(() => Edit(c))">✏️</button>
                                        <button class="btn btn-sm btn-outline-danger" @onclick="@(() => Delete(c))">🗑️</button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="OnClose">Close</button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Edit Modal -->
@if (Editing is not null) {
    <div class="modal fade show d-block" tabindex="-1"
         style="background-color:rgba(0,0,0,.4); z-index:1060;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@((IsNew ? "Add" : "Edit") + " Customer")</h5>
                    <button type="button" class="btn-close" @onclick="CloseEditModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-2">
                        <label class="form-label">Name</label>
                        <input class="form-control" @bind="Editing.Name" />
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Address</label>
                        <input class="form-control" @bind="Editing.Address" />
                    </div>
                    <div class="row mb-2">
                        <div class="col">
                            <label class="form-label">Latitude</label>
                            <input class="form-control" type="number" step="0.00001" @bind="Editing.Latitude" />
                        </div>
                        <div class="col">
                            <label class="form-label">Longitude</label>
                            <input class="form-control" type="number" step="0.00001" @bind="Editing.Longitude" />
                        </div>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Default Job Type</label>
                        <select class="form-select" @bind="Editing.DefaultJobType">
                            <option>Depot</option>
                            <option>Pickup</option>
                            <option>Delivery</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseEditModal">Cancel</button>
                    <button class="btn btn-primary" @onclick="SaveEdit">Save</button>
                </div>
            </div>
        </div>
    </div>
}


@code {
    [Parameter] public bool Visible { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public List<Customer> Customers { get; set; } = new();

    private const string FilePath = "wwwroot/data/customers.json";
    private Customer? Editing;
    private bool IsNew;

    private void AddNew() {
        Editing = new Customer {
            Id = NextId(),
            DefaultJobType = "Delivery"
        };
        IsNew = true;
    }

    public void OpenForNewCustomer(MapPosition pos)
    {
        Editing = new Customer {
            Id = NextId(),
            Name = pos.Region,
            Address = pos.Address,
            DefaultJobType = "Delivery",
            Latitude = pos.Lat,
            Longitude = pos.Lng
        };
        IsNew = true;

    }

    private void Edit(Customer c) {
        Editing = new Customer {
            Id = c.Id,
            Name = c.Name,
            Address = c.Address,
            Latitude = c.Latitude,
            Longitude = c.Longitude,
            DefaultJobType = c.DefaultJobType
        };
        IsNew = false;
    }

    private async Task SaveEdit() {
        if (Editing is null) return;

        if (IsNew) {
            Customers.Add(Editing);
        } else {
            var existing = Customers.FirstOrDefault(x => x.Id == Editing.Id);
            if (existing is not null) {
                existing.Name = Editing.Name;
                existing.Address = Editing.Address;
                existing.Latitude = Editing.Latitude;
                existing.Longitude = Editing.Longitude;
                existing.DefaultJobType = Editing.DefaultJobType;
            }
        }

        Editing = null;
        await SaveToFile();
    }

    private void CloseEditModal() => Editing = null;

    private async Task Delete(Customer c) {
        Customers.Remove(c);
        await SaveToFile();
    }

    private async Task LoadFromFile() {
        try {
            if (!File.Exists(FilePath)) {
                Directory.CreateDirectory(Path.GetDirectoryName(FilePath)!);
                await File.WriteAllTextAsync(FilePath, "[]");
            }

            var json = await File.ReadAllTextAsync(FilePath);
            var data = JsonSerializer.Deserialize<List<Customer>>(json) ?? new();
            Customers.Clear();
            Customers.AddRange(data);
        } catch (Exception ex) {
            Console.WriteLine($"LoadFromFile error: {ex.Message}");
        }
    }

    private async Task SaveToFile() {
        try {
            Directory.CreateDirectory(Path.GetDirectoryName(FilePath)!);
            var json = JsonSerializer.Serialize(Customers, new JsonSerializerOptions { WriteIndented = true });
            await File.WriteAllTextAsync(FilePath, json);
        } catch (Exception ex) {
            Console.WriteLine($"SaveToFile error: {ex.Message}");
        }
    }

    private int NextId() {
        return Customers.Count == 0 ? 0 : Customers.Max(c => c.Id) + 1;
    }
}
