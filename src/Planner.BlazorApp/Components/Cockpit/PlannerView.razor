@page "/iso-planner"
@rendermode InteractiveServer

@using Planner.Application.Messaging
@using Planner.BlazorApp.Services
@using Planner.Contracts.Messages
@using Planner.Contracts.Messages.VehicleRoutingProblem
@using Planner.Domain.Entities
@using static Planner.BlazorApp.Components.Cockpit.PlannerMap

@inject DataCenterService DataCenter
@inject IConfiguration configuration

<div class="position-relative w-100 h-100" style="overflow:hidden;"
     @oncontextmenu:preventDefault="true"
     @oncontextmenu="ShowMenu"
     @onclick="HideMenu">
    <!-- Full-screen Google Map -->
    <PlannerMap @ref="mapRef"
        DepotLat="@Depot.Latitude" DepotLon="@Depot.Longitude"
        JobPositionPicked="JobPositionPicked"
                Routes="@MapRoutes" Customers="@MapCustomers" />

    <!-- Context Menu -->
    @if (ShowContextMenu)
    {
        <div class="position-absolute bg-white border rounded shadow-sm"
             style="z-index:1050; width:180px; top:@($"{MenuTop}px"); left:@($"{MenuLeft}px");">
            <button class="dropdown-item py-2" @onclick=@(() => OpenModal("Customers"))>👥 Customers</button>
            <button class="dropdown-item py-2" @onclick=@(() => OpenModal("Vehicles"))>🚚 Vehicles</button>
            <button class="dropdown-item py-2" @onclick=@(() => OpenModal("Jobs"))>📦 Jobs</button>
            <button class="dropdown-item py-2" @onclick=@(() => OpenModal("Routes"))>🗺️ Routes</button>
        </div>
    }

    <!-- Modals -->
    <CustomersModal Visible="@ShowCustomersModal"
                    Customers="@DataCenter.Customers"
                    OnClose="@(() => {
                        @ShowCustomersModal = false;
                        WhenCustomersChanged();
                    })"
                    @ref="customersModal" />

    <VehiclesModal Visible="@ShowVehiclesModal"
                   Vehicles="@DataCenter.Vehicles"
                   OnClose="@(() => @ShowVehiclesModal = false)" />

    <JobsModal Visible="@ShowJobsModal"
               Jobs="@DataCenter.Jobs"
               Customers="@DataCenter.Customers"
               Vehicles="@DataCenter.Vehicles"
               OnClose="@(() => @ShowJobsModal = false)"
               OnSolve="@SolveVrp" />

    <RoutesModal Visible="@ShowRoutesModal"
                 Routes="@Routes"
                 OnHighlight="HighlightRoute"
                 OnReset="ResetHighlights"
                 OnClose="@(() => ShowRoutesModal = false)" />
</div>

@code {
    // --- State collections ---
    private List<VehicleRoute> Routes = new();

    private double saturation = 0.85;
    private double lightness = 0.55;

    private (double Latitude, double Longitude) Depot = (-31.953823, 115.876140);


    private List<MapRoute> MapRoutes = [];

    private void WhenRoutesChanged() {
        MapRoutes = Routes.Select(r => new MapRoute {
            RouteName = r.VehicleName,
            Color = ColourHelper.ColourFromString(r.VehicleName, saturation, lightness) ?? "#FF0000",
            Points = r.Stops
            .Join(DataCenter.Jobs, s => s.JobId, j => j.Id, (s, j) => new { s, j })
            .Join(DataCenter.Customers, sj => sj.j.CustomerId, c => c.Id,
                (sj, c) => new MapMarker {
                     Lat = c.Latitude,
                        Lng = c.Longitude,
                        Label = c.Name
                    })
            .ToList()

            // Points = r.Stops.Select(s =>
            // {
            //     var cid = DataCenter.Jobs.FirstOrDefault(j => j.Id == s.JobId);

            //     var c = DataCenter.Customers.FirstOrDefault(c => c.Id == s.JobId);
            //     return new MapMarker
            //     {
            //         Lat = c?.Latitude ?? 0,
            //         Lng = c?.Longitude ?? 0,
            //         Label = c?.Name ?? s.JobName,
            //     };
            // }).ToList()
        }).ToList();
    }

    private List<MapMarker> MapCustomers = [];

    private void WhenCustomersChanged()
    {
        MapCustomers = DataCenter.Customers.Select(c => new MapMarker {
            Lat = c.Latitude,
            Lng = c.Longitude,
            Label = c.Name
        }).ToList();
    }


    private PlannerMap? mapRef;

    // --- Context menu ---
    private bool ShowContextMenu;
    private double MenuLeft, MenuTop;

    // --- Modals ---
    private bool ShowCustomersModal, ShowVehiclesModal, ShowJobsModal, ShowRoutesModal;

    protected override async Task OnAfterRenderAsync(bool firstRender) {
        if (firstRender) {
            DataCenter.VrpResultReceived += async msg => await OnVrpResultReceived(msg);
            await DataCenter.InitializeAsync();
            WhenCustomersChanged();
            await InvokeAsync(StateHasChanged);
        }
    }

    // --- Context Menu Logic ---
    private void ShowMenu(MouseEventArgs e)
    {
        MenuLeft = e.OffsetX;
        MenuTop = e.OffsetY;
        ShowContextMenu = true;
    }

    private void HideMenu()
    {
        ShowContextMenu = false;
    }

    private void OpenModal(string name)
    {
        HideMenu();
        ShowCustomersModal = name == "Customers";
        ShowVehiclesModal = name == "Vehicles";
        ShowJobsModal = name == "Jobs";
        ShowRoutesModal = name == "Routes";
    }

    // --- SignalR Result Handler ---
    private async Task OnVrpResultReceived(VrpResultMessage msg)
    {
        Console.WriteLine($"[{DateTime.Now}] VRP result received. {msg.RequestId}");
        Routes = msg.Result.Routes;
        saturation = 0.85;
        lightness = 0.55;
        WhenRoutesChanged();
        await InvokeAsync(StateHasChanged);
    }

    // --- Solve VRP trigger (called from JobsModal) ---
    private async Task SolveVrp()
    {
        HideMenu();
        ShowJobsModal = false;

        saturation = 0.85;
        lightness = 0.75;

        var vrpJobs = DataCenter.Jobs.Prepend(new Job {
            Id = 0,
            CustomerId = -1,
            Name = "Depot",
            Type = JobType.Depot
        });

        var MakeDistanceMatrix = () =>
        {
            var size = vrpJobs.Count(); // +1 for depot
            var points = vrpJobs.Select(j => DataCenter.Customers.FirstOrDefault(c => c.Id == j.CustomerId) is { } customer ? (customer.Latitude, customer.Longitude) : Depot).ToArray();

            var matrix = new double[size][];
            var rand = new Random();
            for (int i = 0; i < size; i++)
            {
                matrix[i] = new double[size];
                for (int j = 0; j < size; j++)
                {
                    if (i == j)
                        matrix[i][j] = 0;
                    else
                        matrix[i][j] = 111.3200  * Math.Abs(points[i].Latitude - points[j].Latitude) + Math.Abs(points[i].Longitude - points[j].Longitude); // Manhattan distance
                }
            }
            return matrix;
        };

        var MakeTravelMinutes = MakeDistanceMatrix().Select(row => row.Select(distance => distance * 2).ToArray()).ToArray();   // 30KPH average speed


        var request = new VrpRequestMessage
        {
            RequestId = Guid.NewGuid(),
            Request = new VrpRequest
            {
                Jobs = vrpJobs.ToList(),
                Vehicles = DataCenter.Vehicles,
                DistanceKm = MakeDistanceMatrix(),
                TravelMinutes = MakeTravelMinutes,
            },
            CompletedAt = DateTime.UtcNow
        };

        using var client = new HttpClient { BaseAddress = new Uri(configuration["Planner.Api:BaseUrl"]!) };
        var response = await client.PostAsJsonAsync(configuration["Planner.Api:VRP.Solver.Endpoint"], request);
        if (response.IsSuccessStatusCode) {
            Console.WriteLine($"[{DateTime.Now}] VRP request successfully sent.  Please wait for a few minutes to get the result.");
        } else
        {
            Console.WriteLine($"[{DateTime.Now}] VRP request failed to sent.  Please check the connection.");
        }
        await InvokeAsync(StateHasChanged);
    }

    private Task HighlightRoute(string args)
    {
        //throw new NotImplementedException();
        return Task.CompletedTask;
    }
    private void ResetHighlights()
    {
        //throw new NotImplementedException();

    }

    private CustomersModal? customersModal;

    private Task JobPositionPicked(MapPosition args) {
        if (!(ShowContextMenu || ShowCustomersModal || ShowJobsModal || ShowRoutesModal || ShowVehiclesModal))
        {
            ShowCustomersModal = true;
            customersModal?.OpenForNewCustomer(args);
        }
        return Task.CompletedTask;
    }

}
