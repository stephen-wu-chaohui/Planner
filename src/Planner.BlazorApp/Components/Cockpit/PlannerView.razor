@page "/planner-view"
@rendermode InteractiveServer

@using Planner.Application.Messaging
@using Planner.Contracts.Messages
@using Planner.Contracts.Messages.VehicleRoutingProblem
@using Planner.Domain.Entities
@using static Planner.BlazorApp.Components.Cockpit.PlannerMap


@inject IMessageHubClient Hub

<div class="position-relative w-100 h-100" style="overflow:hidden;"
     @oncontextmenu:preventDefault="true"
     @oncontextmenu="ShowMenu"
     @onclick="HideMenu">
    <!-- Full-screen Google Map -->
    <PlannerMap @ref="mapRef"
        DepotLat="@Depot.Latitude" DepotLon="@Depot.Longitude"
        JobPositionPicked="JobPositionPicked"
                Routes="@MapRoutes" Customers="@MapCustomers" />

    <!-- Context Menu -->
    @if (ShowContextMenu)
    {
        <div class="position-absolute bg-white border rounded shadow-sm"
             style="z-index:1050; width:180px; top:@($"{MenuTop}px"); left:@($"{MenuLeft}px");">
            <button class="dropdown-item py-2" @onclick=@(() => OpenModal("Customers"))>👥 Customers</button>
            <button class="dropdown-item py-2" @onclick=@(() => OpenModal("Vehicles"))>🚚 Vehicles</button>
            <button class="dropdown-item py-2" @onclick=@(() => OpenModal("Jobs"))>📦 Jobs</button>
            <button class="dropdown-item py-2" @onclick=@(() => OpenModal("Routes"))>🗺️ Routes</button>
        </div>
    }

    <!-- Modals -->
    <CustomersModal Visible="@ShowCustomersModal"
                    Customers="@Customers"
                    OnClose="@(() => @ShowCustomersModal = false)"
                    @ref="customersModal" />

    <VehiclesModal Visible="@ShowVehiclesModal"
                   Vehicles="@Vehicles"
                   OnClose="@(() => @ShowVehiclesModal = false)" />

    <JobsModal Visible="@ShowJobsModal"
               Jobs="@Jobs"
               Customers="@Customers"
               Vehicles="@Vehicles"
               OnClose="@(() => @ShowJobsModal = false)"
               OnSolve="@SolveVrp" />

    <RoutesModal Visible="@ShowRoutesModal"
                 Routes="@Routes"
                 OnHighlight="HighlightRoute"
                 OnReset="ResetHighlights"
                 OnClose="@(() => ShowRoutesModal = false)" />
</div>

@code {
    // --- State collections ---
    private readonly List<Customer> Customers = new();
    private readonly List<Vehicle> Vehicles = new();
    private readonly List<Job> Jobs = new();
    private readonly List<VehicleRoute> Routes = new();

    private (double Latitude, double Longitude) Depot = (-31.953823, 115.876140);


    private List<MapRoute> MapRoutes => Routes.Select(r => new MapRoute
    {
        RouteName = r.VehicleName,
        Color = "#4285F4",
        Points = r.Stops.Select(s =>
        {
            var c = Customers.FirstOrDefault(x => x.Id == s.JobId);
            return new MapMarker
            {
                Lat = c?.Latitude ?? 0,
                Lng = c?.Longitude ?? 0,
                Label = c?.Name ?? s.JobName,
            };
        }).ToList()
    }).ToList();

    private List<MapMarker> MapCustomers => Customers.Select(c => new MapMarker
    {
        Lat = c.Latitude,
        Lng = c.Longitude,
        Label = c.Name
    }).ToList();

    private PlannerMap? mapRef;

    // --- Context menu ---
    private bool ShowContextMenu;
    private double MenuLeft, MenuTop;

    // --- Modals ---
    private bool ShowCustomersModal, ShowVehiclesModal, ShowJobsModal, ShowRoutesModal;

    protected override async Task OnInitializedAsync()
    {
        await Hub.SubscribeAsync<VrpResultMessage>(
            MessageRoutes.VRPSolverResult,
            async msg => await OnVrpResultReceived(msg)
        );
    }

    // --- Context Menu Logic ---
    private void ShowMenu(MouseEventArgs e)
    {
        MenuLeft = e.OffsetX;
        MenuTop = e.OffsetY;
        ShowContextMenu = true;
    }

    private void HideMenu()
    {
        ShowContextMenu = false;
    }

    private void OpenModal(string name)
    {
        HideMenu();
        ShowCustomersModal = name == "Customers";
        ShowVehiclesModal = name == "Vehicles";
        ShowJobsModal = name == "Jobs";
        ShowRoutesModal = name == "Routes";
    }

    // --- SignalR Result Handler ---
    private async Task OnVrpResultReceived(VrpResultMessage msg)
    {
        Console.WriteLine($"[PlannerView] Received VRP result {msg.RequestId}");
        Routes.Clear();
        Routes.AddRange(msg.Result.Routes);
        await InvokeAsync(StateHasChanged);
        return;

        if (mapRef is null) return;

        // await mapRef.ClearRoutesAsync();
        foreach (var route in msg.Result.Routes.Where(r => r.Used))
        {
            // we’ll later load coordinates from Customers
            var points = route.Stops.Select(s =>
            {
                var c = Customers.FirstOrDefault(x => x.Id == s.JobId);
                return new MapMarker
                {
                    Lat = c?.Latitude ?? 0,
                    Lng = c?.Longitude ?? 0,
                    Label = c?.Name ?? s.JobName,
                    JobType = s.JobType.ToString(),
                    Color = "#4285F4",
                    RouteName = route.VehicleName
                };
            }).ToList();

            await mapRef.DrawRouteAsync(route.VehicleName, "#4285F4", points);
        }
        await mapRef.FitToBoundsAsync();
    }

    // --- Solve VRP trigger (called from JobsModal) ---
    private async Task SolveVrp()
    {
        var vrpJobs = Jobs.Prepend(new Job {
            Id = 0,
            CustomerId = -1,
            Name = "Depot",
            Type = JobType.Depot
        });

        var MakeDistanceMatrix = () =>
        {
            var size = vrpJobs.Count(); // +1 for depot
            var points = vrpJobs.Select(j => Customers.FirstOrDefault(c => c.Id == j.CustomerId) is { } customer ? (customer.Latitude, customer.Longitude) : Depot).ToArray();

            var matrix = new double[size][];
            var rand = new Random();
            for (int i = 0; i < size; i++)
            {
                matrix[i] = new double[size];
                for (int j = 0; j < size; j++)
                {
                    if (i == j)
                        matrix[i][j] = 0;
                    else
                        matrix[i][j] = 111.3200  * Math.Abs(points[i].Latitude - points[j].Latitude) + Math.Abs(points[i].Longitude - points[j].Longitude); // Manhattan distance
                }
            }
            return matrix;
        };

        var MakeTravelMinutes = MakeDistanceMatrix().Select(row => row.Select(distance => distance * 2).ToArray()).ToArray();   // 30KPH average speed


        var request = new VrpRequestMessage
        {
            RequestId = Guid.NewGuid(),
            Request = new VrpRequest
            {
                Jobs = vrpJobs.ToList(),
                Vehicles = Vehicles,
                DistanceKm = MakeDistanceMatrix(),
                TravelMinutes = MakeTravelMinutes,
            },
            CompletedAt = DateTime.UtcNow
        };

        Console.WriteLine($"[PlannerView] Sending VRP request {request.RequestId}");
        using var client = new HttpClient { BaseAddress = new Uri("https://localhost:7085/") };
        var response = await client.PostAsJsonAsync("api/vrp/solve", request);
        if (response.IsSuccessStatusCode) {
            Console.WriteLine("Received VRP solution from API.");
        }

    }
    private Task HighlightRoute(string args)
    {
        //throw new NotImplementedException();
        return Task.CompletedTask;
    }
    private void ResetHighlights()
    {
        //throw new NotImplementedException();

    }


    private CustomersModal? customersModal;

    private Task JobPositionPicked((double lat, double lng) args)
    {
        if (!(ShowContextMenu || ShowCustomersModal || ShowJobsModal || ShowRoutesModal || ShowVehiclesModal))
        {
            ShowCustomersModal = true;
            customersModal?.OpenForNewCustomer(args.lat, args.lng);
        }
        return Task.CompletedTask;
    }

}
