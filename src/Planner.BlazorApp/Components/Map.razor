
@using Planner.Application.Messaging
@using Planner.Contracts.Messages
@using Planner.Contracts.Messages.LinearSolver
@using Planner.Contracts.Messages.VehicleRoutingProblem

@namespace Planner.BlazorApp.Components

@inject IMessageHubClient hub  // your existing abstraction over SignalR

    <GoogleMap DepotLat="-31.9505"
               DepotLon="115.8605"
               Routes="@routes"
               Height="100%" />


<style>
    .map-container {
        flex: 1; /* fills the available flex space */
        width: 100%; /* full horizontal stretch */
        height: 100%; /* safe fallback if parent isn’t flex */
        background-color: #dfefff;
        position: relative; /* helpful if you’ll absolutely position map layers */
    }
</style>

@code {
    private List<GoogleMap.RouteDto> routes = new()
    {
        new() {
            VehicleId = "Truck-1",
            Points = new() {
                new() { Lat = -31.9505, Lon = 115.8605 },
                new() { Lat = -31.9783, Lon = 115.8180 },
                new() { Lat = -32.0671, Lon = 115.8957 },
                new() { Lat = -31.9505, Lon = 115.8605 }
            }
        },
        new() {
            VehicleId = "Truck-2",
            Points = new() {
                new() { Lat = -31.9505, Lon = 115.8605 },
                new() { Lat = -32.0569, Lon = 115.7439 },
                new() { Lat = -31.9505, Lon = 115.8605 }
            }
        }
    };

    protected override async Task OnInitializedAsync()
    {
        await hub.SubscribeAsync<VrpResultMessage>(
            MessageRoutes.VRPSolverResult,
            result => InvokeAsync(() => {
                Console.WriteLine($"MessageHub received data {MessageRoutes.LPSolverResult}.");
                routes = ConvertToRoutes(result);
                StateHasChanged();
            }));
    }

    private static List<GoogleMap.RouteDto> ConvertToRoutes(VrpResultMessage msg)
    {
        // adapt this based on your real message contract
        var list = new List<GoogleMap.RouteDto>();
        foreach (var vehicle in msg.Response.Vehicles)
        {
            list.Add(new GoogleMap.RouteDto {
                VehicleId = vehicle.VehicleId,
                Points = vehicle.Stops.Select(s => new GoogleMap.RoutePoint {
                    Lat = s.Latitude,
                    Lon = s.Longitude
                }).ToList()
            });
        }
        return list;
    }

    public Task ClearRoutesAsync()
    {
        routes = new();
        StateHasChanged();
        return Task.CompletedTask;
    }
}
