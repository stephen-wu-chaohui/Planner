@page "/LinearSolver"
@rendermode InteractiveServer

@using System.Text.Json
@using Planner.BlazorApp.Services
@using Planner.Contracts.Optimization.Responses

@inject IOptimizationHubClient hub

<PageTitle>Linear Solver</PageTitle>

<section class="p-4">

    <h1>Linear Solver Inside</h1>

    <h3>Welcome to the Linear Solver, perfect for optimizing your workflows!</h3>
    <p>Please use any API clients to interact with the Linear Solver service, or: </p>

    <button class="btn btn-primary" disabled="@(!string.IsNullOrEmpty(ExceptionMessage))" @onclick="() => ShowPoster = true">Open Linear Poster</button>

    <LinearPoster Visible="@ShowPoster" OnCloseClicked="() => ShowPoster = false" />
</section>

<section class="p-4">
    @if (!string.IsNullOrEmpty(ExceptionMessage))
    {
        <p><b>@ExceptionMessage</b></p>
    } else if (results.Count == 0)
    {
        <p><em>No results received yet...</em></p>
    } else
    {
        <table class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th>Request ID</th>
                    <th>Status</th>
                    <th>Objective Value</th>
                    <th>Completed At</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var r in results)
                {
                    <tr>
                        <td>@r.RequestId</td>
                        <td>@r.Status</td>
                        <td>@r.ObjectiveValue</td>
                        <td>@r.CompletedAt.ToLocalTime()</td>
                    </tr>
                }
            </tbody>
        </table>
    }

</section>

@code {

    private bool ShowPoster;
    private string ExceptionMessage = "";

    private readonly List<SolverResultRow> results = new();

    protected override Task OnInitializedAsync()
    {
        try
        {
            hub.OptimizationCompleted += r => InvokeAsync(() => {
                Console.WriteLine($"MessageHub received data {r.OptimizationRunId}.");
                results.Add(new SolverResultRow(r));
                StateHasChanged();
            });

        } catch(Exception ex)
        {
            ExceptionMessage = ex.Message;
        }
        return Task.CompletedTask;
    }

    private class SolverResultRow {
        public string? RequestId { get; set; }
        public string? Status { get; set; }
        public double ObjectiveValue { get; set; }
        public DateTime CompletedAt { get; set; }

        public SolverResultRow(OptimizeRouteResponse message) {
            RequestId = message.OptimizationRunId.ToString();
            Status = message.Routes.Count.ToString();
            ObjectiveValue = message.TotalCost;
            CompletedAt = message.CompletedAt;
        }
    }

}
