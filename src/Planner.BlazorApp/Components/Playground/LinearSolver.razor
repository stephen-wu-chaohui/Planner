@page "/LinearSolver"
@rendermode InteractiveServer

@using Planner.Application.Messaging
@using Planner.Contracts.Messages
@using Planner.Contracts.Messages.LinearSolver
@using System.Text.Json

@inject IMessageHubClient hub

<PageTitle>Linear Solver</PageTitle>

<section class="p-4">

    <h1>Linear Solver Inside</h1>

    <h3>Welcome to the Linear Solver, perfect for optimizing your workflows!</h3>
    <p>Please use any API clients to interact with the Linear Solver service, or: </p>

    <button class="btn btn-primary" disabled="@(!string.IsNullOrEmpty(ExceptionMessage))" @onclick="() => ShowPoster = true">Open Linear Poster</button>

    <LinearPoster Visible="@ShowPoster" OnCloseClicked="() => ShowPoster = false" />
</section>

<section class="p-4">
    @if (!string.IsNullOrEmpty(ExceptionMessage))
    {
        <p><b>@ExceptionMessage</b></p>
    } else if (results.Count == 0)
    {
        <p><em>No results received yet...</em></p>
    } else
    {
        <table class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th>Request ID</th>
                    <th>Status</th>
                    <th>Objective Value</th>
                    <th>Completed At</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var r in results)
                {
                    <tr>
                        <td>@r.RequestId</td>
                        <td>@r.Status</td>
                        <td>@r.ObjectiveValue</td>
                        <td>@r.CompletedAt.ToLocalTime()</td>
                    </tr>
                }
            </tbody>
        </table>
    }

</section>

@code {

    private bool ShowPoster;
    private string ExceptionMessage = "";

    private readonly List<SolverResultRow> results = new();

    protected override Task OnInitializedAsync()
    {
        try
        {
            hub.SubscribeAsync<LinearSolverResultMessage>(MessageRoutes.LPSolverResult,
                r => InvokeAsync(() => {
                    Console.WriteLine($"MessageHub received data {MessageRoutes.LPSolverResult}.");
                    try
                    {
                        var busQueue = (r.RequestId ?? "unknown") + "_" + MessageRoutes.LPSolverResult;
                        var FilePath = $"wwwroot/data/{busQueue}-{DateTime.Now.ToString("yyyy-MM-dd HH-mm-ss")}.json";
                        Directory.CreateDirectory(Path.GetDirectoryName(FilePath)!);
                        var json = JsonSerializer.Serialize(r, new JsonSerializerOptions { WriteIndented = true });
                        // File.WriteAllText(FilePath, json);
                    } catch(Exception ex)
                    {
                        Console.WriteLine($"[{DateTime.Now.ToString()}] Exception: {ex.Message} .");
                    }
                    results.Add(new SolverResultRow(r));
                    StateHasChanged();
                })
            );

        } catch(Exception ex)
        {
            ExceptionMessage = ex.Message;
        }
        return Task.CompletedTask;
    }

    private class SolverResultRow {
        public string? RequestId { get; set; }
        public string? Status { get; set; }
        public double ObjectiveValue { get; set; }
        public DateTime CompletedAt { get; set; }

        public SolverResultRow(LinearSolverResultMessage message)
        {
            RequestId = message.RequestId;
            Status = message.Response.Status;
            ObjectiveValue = message.Response.ObjectiveValue;
            CompletedAt = message.CompletedAt;
        }

        public SolverResultRow(VrpResultMessage message)
        {
            RequestId = message.RequestId.ToString();
            Status = message.Result.Routes.Count.ToString();
            ObjectiveValue = message.Result.TotalCost;
            CompletedAt = message.CompletedAt;
        }
    }

}
