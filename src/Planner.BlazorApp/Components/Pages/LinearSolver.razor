@page "/LinearSolver"
@rendermode InteractiveServer

@using Planner.Application.Messaging
@using Planner.BlazorApp.Components.Shared
@using Planner.Contracts.Messages
@using Planner.Contracts.Messages.LinearSolver

@inject IMessageHubClient hub

<PageTitle>Linear Solver</PageTitle>

<section class="p-4">

    <h1>Linear Solver Inside</h1>

    <h3>Welcome to the Linear Solver, perfect for optimizing your workflows!</h3>
    <p>Please use any API clients to interact with the Linear Solver service, or: </p>
    <button class="btn btn-primary" @onclick="() => ShowPoster = true">Open Linear Poster</button>

    <LinearPoster Visible="@ShowPoster" OnCloseClicked="() => ShowPoster = false" />
</section>

<section class="p-4">
    @if (results.Count == 0)
    {
        <p><em>No results received yet...</em></p>
    } else
    {
        <table class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th>Request ID</th>
                    <th>Status</th>
                    <th>Objective Value</th>
                    <th>Completed At</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var r in results)
                {
                    <tr>
                        <td>@r.RequestId</td>
                        <td>@r.Status</td>
                        <td>@r.ObjectiveValue</td>
                        <td>@r.CompletedAt.ToLocalTime()</td>
                    </tr>
                }
            </tbody>
        </table>
    }

</section>

@code {

    private bool ShowPoster;

    private readonly List<LinearSolverResultRow> results = new();

    protected override Task OnInitializedAsync()
    {
        hub.SubscribeAsync<LinearSolverResultMessage>(MessageRoutes.LPSolverResult,
            r => InvokeAsync(() => {
                Console.WriteLine($"MessageHub received data {MessageRoutes.LPSolverResult}.");
                results.Add(new LinearSolverResultRow(r));
                StateHasChanged();
            })
        );
        return Task.CompletedTask;
    }

    private record LinearSolverResultRow(LinearSolverResultMessage Message) {
        public string? RequestId => Message.RequestId;
        public string? Status => Message.Response.Status;
        public double ObjectiveValue => Message.Response.ObjectiveValue;
        public DateTime CompletedAt => Message.CompletedAt;
    }

}
