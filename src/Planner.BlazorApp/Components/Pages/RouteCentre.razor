@page "/route-centre"
@using Planner.Application.Messaging
@using Planner.BlazorApp.Components.Cockpit
@using Planner.Contracts.Messages
@using Planner.Contracts.Messages.VehicleRoutingProblem
@using Planner.Domain.Entities
@inject IMessageHubClient Hub

<div class="container-fluid h-100">
    <div class="row h-50">
        <!-- Upper Zone -->
        <div class="col-6 h-100 border-end p-0">
            <PlannerMap @ref="mapRef" OnMapClick="OnMapClicked" />
        </div>
        <div class="col-6 h-100 overflow-auto">
            <VrpResults Results="results"
                        OnHighlight="HighlightRoute"
                        OnReset="ResetHighlights" />
        </div>
    </div>

    <div class="row h-50 border-top">
        <!-- Lower Zone -->
        <div class="col-6 h-100 overflow-auto border-end">
            <Jobs Items="jobs" OnItemsChanged="OnJobsChanged" />
        </div>
        <div class="col-6 h-100 overflow-auto">
            <Vehicles Items="vehicles" OnItemsChanged="OnVehiclesChanged" />
        </div>
    </div>
</div>

@code {
    private PlannerMap? mapRef;
    private readonly List<VrpResultMessage> results = new();
    private readonly List<MapMarker> jobs = new();
    private readonly List<Vehicle> vehicles = new();

    protected override async Task OnInitializedAsync()
    {
        await Hub.SubscribeAsync<VrpResultMessage>(
            MessageRoutes.VRPSolverResult,
            async msg => await OnVrpResultReceived(msg)
        );
    }

    private async Task OnVrpResultReceived(VrpResultMessage msg)
    {
        Console.WriteLine($"[RouteCentre] Received VRP result {msg.RequestId}");
        results.Add(msg);
        await InvokeAsync(StateHasChanged);

        if (mapRef is null) return;
        await mapRef.ClearRoutesAsync();
        foreach (var route in msg.Result.Routes.Where(r => r.Used))
        {
            // await DrawRouteOnMap(route, msg.Result.Routes);
        }
        await mapRef.FitToBoundsAsync();
    }

    private async Task DrawRouteOnMap(VehicleRoute route, List<Job> jobs)
    {
        if (mapRef is null || route.Stops.Count == 0) return;

        string color = route.VehicleId switch
        {
            0 => "#4285F4",
            1 => "#34A853",
            2 => "#FBBC05",
            3 => "#EA4335",
            _ => "#9E9E9E"
        };

        var points = new List<MapMarker>();
        foreach (var stop in route.Stops)
        {
            var job = jobs.FirstOrDefault(j => j.Id == stop.JobId);
            if (job is null) continue;

            var marker = new MapMarker
            {
                // Lat = job.Latitude,
                // Lng = job.Longitude,
                Label = job.Name,
                JobType = stop.JobType.ToString(),
                Color = color,
                RouteName = route.VehicleName,
                Arrival = stop.ArrivalTime,
                Departure = stop.DepartureTime,
                PalletLoad = stop.PalletLoad,
                WeightLoad = stop.WeightLoad,
                RefrigeratedLoad = stop.RefrigeratedLoad
            };
            points.Add(marker);
            await mapRef.AddMarkerAsync(marker);
        }

        // await mapRef.DrawRouteAsync(route.VehicleName, color, points);
    }

    private async Task HighlightRoute(string name)
    {
        if (mapRef is not null)
            await mapRef.HighlightRouteAsync(name);
    }

    private async Task ResetHighlights()
    {
        if (mapRef is not null)
            await mapRef.ResetHighlightsAsync();
    }

    private Task OnJobsChanged(List<MapMarker> updated)
    {
        jobs.Clear();
        jobs.AddRange(updated);
        StateHasChanged();
        return Task.CompletedTask;
    }

    private Task OnVehiclesChanged(List<Vehicle> updated)
    {
        vehicles.Clear();
        vehicles.AddRange(updated);
        StateHasChanged();
        return Task.CompletedTask;
    }

    private void OnMapClicked(double lat, double lng)
    {
        jobs.Add(new MapMarker { Lat = lat, Lng = lng, Label = $"Job {jobs.Count + 1}" });
    }
}
