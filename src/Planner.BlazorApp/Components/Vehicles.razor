@using Planner.Contracts.Messages.VehicleRoutingProblem
@using Planner.Domain.Entities

<div class="p-2">
    <h5>🚚 Vehicles</h5>
    <button class="btn btn-sm btn-primary mb-2" @onclick="AddNew">+ Add Vehicle</button>

    <table class="table table-sm table-bordered align-middle">
        <thead>
            <tr>
                <th>Name</th>
                <th>Cap (Pallets)</th>
                <th>Cap (Weight)</th>
                <th>Shift (min)</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var v in Items) {
                <tr>
                    <td>@v.Name</td>
                    <td>@v.MaxPallets</td>
                    <td>@v.MaxWeight</td>
                    <td>@v.ShiftLimitMinutes</td>
                    <td>
                        <button class="btn btn-sm btn-outline-secondary" @onclick="() => Edit(v)">Edit</button>
                        <button class="btn btn-sm btn-outline-danger" @onclick="() => Delete(v)">🗑️</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    @if (editing is not null) {
        <div class="modal fade show d-block" tabindex="-1" style="background-color:rgba(0,0,0,.4);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">@((isNew ? "Add" : "Edit") + " Vehicle")</h5>
                        <button type="button" class="btn-close" @onclick="CloseModal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-2">
                            <label>Name</label>
                            <input class="form-control" @bind="editing.Name" />
                        </div>
                        <div class="mb-2">
                            <label>Max Pallets</label>
                            <input class="form-control" type="number" @bind="editing.MaxPallets" />
                        </div>
                        <div class="mb-2">
                            <label>Max Weight</label>
                            <input class="form-control" type="number" @bind="editing.MaxWeight" />
                        </div>
                        <div class="mb-2">
                            <label>Shift Limit (minutes)</label>
                            <input class="form-control" type="number" @bind="editing.ShiftLimitMinutes" />
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" @onclick="CloseModal">Cancel</button>
                        <button class="btn btn-primary" @onclick="Save">Save</button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public List<Vehicle> Items { get; set; } = new();
    [Parameter] public EventCallback<List<Vehicle>> OnItemsChanged { get; set; }

    private Vehicle? editing;
    private bool isNew;

    private void AddNew() { editing = new Vehicle(); isNew = true; }

    private void Edit(Vehicle item) {
        editing = new Vehicle {
            Name = item.Name,
            MaxPallets = item.MaxPallets,
            MaxWeight = item.MaxWeight,
            ShiftLimitMinutes = item.ShiftLimitMinutes
        };
        isNew = false;
    }

    private async Task Save() {
        if (editing is null) return;
        if (isNew)
            Items.Add(editing);
        else {
            var existing = Items.FirstOrDefault(v => v.Name == editing.Name);
            if (existing is not null) {
                existing.MaxPallets = editing.MaxPallets;
                existing.MaxWeight = editing.MaxWeight;
                existing.ShiftLimitMinutes = editing.ShiftLimitMinutes;
            }
        }
        editing = null;
        await OnItemsChanged.InvokeAsync(Items);
    }

    private async Task Delete(Vehicle item) {
        Items.Remove(item);
        await OnItemsChanged.InvokeAsync(Items);
    }

    private void CloseModal() => editing = null;
}
