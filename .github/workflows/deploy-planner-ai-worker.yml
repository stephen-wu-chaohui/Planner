name: Deploy Planner.AI to DigitalOcean

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Droplet
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # 1. Prepare the workspace
            mkdir -p ~/planner-ai
            cd ~/planner-ai

            # 2. Initialize or update a Sparse Checkout
            if [ ! -d ".git" ]; then
                git init
                git remote add origin https://github.com/stephen-wu-chaohui/Planner
                git config core.sparseCheckout true
                echo "src/Planner.AI" >> .git/info/sparse-checkout
                echo "src/Planner.AI/*" >> .git/info/sparse-checkout
            fi

            git fetch origin main
            git reset --hard origin/main

            # 3. Navigate to the code
            cd src/Planner.AI

            # 4. Build the image
            # This will now find the Dockerfile in the current directory
            docker build -t planner-ai-worker .

            # 5. Cleanup existing container
            docker stop planner-ai-worker || true
            docker rm planner-ai-worker || true

            # 6. Run the worker
            # IMPORTANT: Ensure your .env file is located at ~/planner-ai/.env
            docker run -d \
                --name planner-ai-worker \
                --restart always \
                --env-file ../../.env \
                planner-ai-worker