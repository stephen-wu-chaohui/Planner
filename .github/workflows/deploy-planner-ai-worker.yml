name: Deploy Planner.AI to DigitalOcean

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Droplet
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # 1. Ensure the directory exists
            mkdir -p ~/planner-ai
            cd ~/planner-ai

            # 2. Handle the Git logic more robustly
            if [ -d ".git" ]; then
                git fetch origin main
                git reset --hard origin/main
            else
                # If the folder has files but isn't a git repo, clean it first
                rm -rf * git clone https://github.com/stephen-wu-chaohui/Planner .
            fi

            # 3. MOVE TO THE SUBDIRECTORY
            # This is where your Dockerfile and worker script are located
            cd src/Planner.AI

            # 4. Build the image
            # Now that we are in the same folder as the Dockerfile, this will work
            docker build -t planner-ai-worker .

            # 5. Restart the container
            docker stop planner-ai-worker || true
            docker rm planner-ai-worker || true

            # 6. Run the worker
            # We use '../../.env' because the .env file is likely at the root ~/planner-ai/
            docker run -d \
                --name planner-ai-worker \
                --restart always \
                --env-file ../../.env \
                planner-ai-worker