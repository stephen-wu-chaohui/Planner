name: Deploy Planner Optimization Worker

on:
  push:
    branches: [ main ]
    paths:
      - "src/Planner.Optimization.Worker/**"
      - ".github/workflows/deploy-worker.yml"

env:
  ACR_NAME: plannerregistry
  RESOURCE_GROUP: PlannerRG
  CONTAINER_APP_NAME: planner-worker
  CONTAINER_ENV: planner-env
  DOCKERFILE_PATH: src/Planner.Optimization.Worker/Dockerfile
  IMAGE_NAME: planner-worker

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # Checkout code
    - name: Checkout
      uses: actions/checkout@v4

    # Login to Azure using your service principal
    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    # ACR login
    - name: Login to ACR
      run: az acr login --name $ACR_NAME

    # Generate version tag
    - name: Set image version
      id: version
      run: echo "VERSION=v$(date +'%Y.%m.%d.%H%M')" >> $GITHUB_OUTPUT

    # Build Docker image
    - name: Build Docker Image
      run: |
        docker build \
          -t $ACR_NAME.azurecr.io/$IMAGE_NAME:${{ steps.version.outputs.VERSION }} \
          -t $ACR_NAME.azurecr.io/$IMAGE_NAME:latest \
          -f $DOCKERFILE_PATH .

    # Push both tags to ACR
    - name: Push image to ACR
      run: |
        docker push $ACR_NAME.azurecr.io/$IMAGE_NAME:${{ steps.version.outputs.VERSION }}
        docker push $ACR_NAME.azurecr.io/$IMAGE_NAME:latest

    # Update container app
    - name: Deploy to Azure Container Apps
      run: |
        az containerapp update \
          --name $CONTAINER_APP_NAME \
          --resource-group $RESOURCE_GROUP \
          --image $ACR_NAME.azurecr.io/$IMAGE_NAME:${{ steps.version.outputs.VERSION }} \
          --set-env-vars RABBITMQ_HOST="rabbitmq" \
                          RABBITMQ_USER="guest" \
                          RABBITMQ_PASS="guest"

    # Output deployed version
    - name: Show deployed revision
      run: |
        echo "Deployed version: ${{ steps.version.outputs.VERSION }}"
        az containerapp show \
          --name $CONTAINER_APP_NAME \
          --resource-group $RESOURCE_GROUP \
          --query "properties.latestRevisionName" -o tsv
