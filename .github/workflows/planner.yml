name: Build & Deploy Planner (.NET 8, API + Blazor)

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  DOTNET_VERSION: '8.0.x'
  CONFIGURATION: Release
  API_PROJECT: 'src/Planner.API/Planner.API.csproj'
  BLAZOR_PROJECT: 'src/Planner.BlazorApp/Planner.BlazorApp.csproj'
  AZURE_WEBAPP_API: 'planner-api'        # <-- your Azure Web App name
  AZURE_WEBAPP_BLAZOR: 'planner-blazor'  # <-- your Blazor Web App name
  SQL_SERVER: 'planner-sql.database.windows.net'
  SQL_DATABASE: 'PlannerDb'
  RESOURCE_GROUP: 'planner-rg'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore Planner.sln

      - name: Build solution
        run: dotnet build Planner.sln --configuration ${{ env.CONFIGURATION }} --no-restore

      - name: Run tests
        run: dotnet test Planner.sln --configuration ${{ env.CONFIGURATION }} --no-build --verbosity normal

      - name: Publish API
        run: dotnet publish ${{ env.API_PROJECT }} -c ${{ env.CONFIGURATION }} -o ./publish/api

      - name: Publish Blazor
        run: dotnet publish ${{ env.BLAZOR_PROJECT }} -c ${{ env.CONFIGURATION }} -o ./publish/blazor

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: planner-artifacts
          path: ./publish/

  deploy-api:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: production
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: planner-artifacts
          path: ./publish

      - name: Deploy Planner API to Azure
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_API }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE_API }}
          package: ./publish/api

      - name: Run EF Core migrations
        run: |
          dotnet tool install --global dotnet-ef
          dotnet ef database update --project src/Planner.Infrastructure/Planner.Infrastructure.csproj \
            --connection "Server=tcp:${{ env.SQL_SERVER }},1433;Database=${{ env.SQL_DATABASE }};User ID=${{ secrets.SQL_USER }};Password=${{ secrets.SQL_PASSWORD }};Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;"
        env:
          PATH: $PATH:~/.dotnet/tools

  deploy-blazor:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: production
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: planner-artifacts
          path: ./publish

      - name: Deploy Blazor WASM to Azure
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_BLAZOR }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE_BLAZOR }}
          package: ./publish/blazor
